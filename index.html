<!DOCTYPE html>
<html>
  <head>
    <title>Title</title>
    <meta charset="utf-8">
    <link rel="stylesheet" href="ocean.css" />
    <style>
      @import url(https://fonts.googleapis.com/css?family=Yanone+Kaffeesatz);
      @import url(https://fonts.googleapis.com/css?family=Droid+Serif:400,700,400italic);
      @import url(https://fonts.googleapis.com/css?family=Ubuntu+Mono:400,700,400italic);

      body { font-family: 'Droid Serif'; }
      h1, h2, h3, h4 {
        font-family: 'Yanone Kaffeesatz';
        font-weight: normal;
      }
      h4 {
        font-size: 1.3em;
        margin: 20px 0px;
      }
      .splash h1, .splash h2 {
        background-color: black;
        opacity: 0.8;
      }
      .large code { font-size: 1.5em }
      .large .hljs-comment { color: white !important}
      .squeez h3 { margin: 0.5em }
      .fade {color: #E0E0E0}
      .spanny { padding: 10px; color: white; background-color: #0b1c2e }
      .nopadding { padding: 0 }
      .libs { background-color: #202020}
      .l50 { float: left; width: 50%; }
      .r50 { float: right; width: 50%; }
      .crap pre { border-right: 5px solid #D81F2A; }
      .nice pre { border-right: 5px solid #69F0AE; }
      /* new */
      .example { background-color: #2b303b}
      .example h2, .example h3 { color: #fff; font-weight: bold; line-height: 0;}
      .example h1 { color: #fff; font-weight: bold; padding: 10px }

      .codeonly h1, .codeonly h2, .codeonly h3, .codeonly h4 { color: white }
      .codeonly { padding: 1em; background-color: #2b303b }
      .codeonly pre { margin: 0 }

      .remark-code-line-highlighted { background-color: #2d9967; color: white}
      .remark-code-line-highlighted * { color: white !important; }

      .remark-slide-scaler { -webkit-box-shadow: 0 !important; box-shadow: none !important; }
      .remark-slide-container {background-color: #2b303b}
      /* new end */
      .corner {border: 5px solid #85C1E9; position: absolute; top: 0px; right: 0px; width: 50%; background-color: #F0F0F0}
      .corner pre {margin: 0; padding: 0}
      .corner.long {height: 300px;}

      .remark-code, .remark-inline-code { font-family: 'Ubuntu Mono'; }
      .invert { background-color: black; color: white; }
      .bad { background-color: #AA1914; color: white;}
      .oki { background-color: #3D9972; color: white;}
      .strike { text-decoration: line-through; }
      .lint { background-color: #f3f3f3; }
      .conversation h3 { margin: 17px; font-size: 28px; }
      .img100 img { width: 100%}
    </style>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.6.0/katex.min.css">
  </head>
  <body>
    <textarea id="source">

class: center, middle, example
background-size: contain
# Effective Coding Principles and Patterns 
### (Java 15 edition)

---
# Agenda:
### Day I: Code design principles (3/4) and exercises (1/4)

--

### Day II: Enterprise Java (validation, persistence, tx etc.)

--

### Homework with free code review (will also send must read books)

---
class: codeonly
.crap[
```java
var users = repository.allUsers();
users
  .flatMap(user -> user.contacts().phoneNumbers().stream())
  .map(PhoneNumber::countryCode)
  .forEach(System.out::println);
```
]

--

### ‚ö†Ô∏è Cognitive load warning

--

```java
var users = repository.allUsers();
users
* .flatMap(this::phoneNumbers)
  .map(PhoneNumber::countryCode)
  .forEach(System.out::println);

private Stream<PhoneNumber> phoneNumbers(User user) {
    return user.contacts().phoneNumbers().stream();
}  
```

--

### üí° Principle: keep code at the same level of abstraction (SLAP)

--

### üí° Principle: reveal intent, hide implementation

---
class: codeonly
### New requirement: Country code with exit code. Plus digits validation needed.

--

```java
Stream<User> users = repository.allUsers();
  users
          .flatMap(this::phoneNumbers)
          .map(PhoneNumber::countryCode)
          .map(countryCode -> {
              var hasOnlyDigits = CharMatcher
                      .inRange('0', '9')
                      .matchesAllOf(countryCode);
              checkArgument(hasOnlyDigits, "Country code must only contain digits, but was %s", withoutExitCode);
              var withExitCode = "+" + countryCode
              return withExitCode;
          })
          .forEach(System.out::println);
```

--

### ‚ö†Ô∏è Mixed levels of abstraction
### ‚ö†Ô∏è Mixed intent with implementation

---
class: codeonly

### Refactoring: extract method

```java
Stream<User> users = repository.allUsers();
  users
          .flatMap(this::phoneNumbers)
          .map(PhoneNumber::countryCode)
*         .map(this::countryCodeWithExitCode)
          .forEach(System.out::println);
```

```java
private String countryCodeWithExitCode(String countryCode) {
  var hasOnlyDigits = CharMatcher
          .inRange('0', '9')
          .matchesAllOf(countryCode);
  checkArgument(hasOnlyDigits, "Country code must only contain digits, but was %s", countryCode);
  var withExitCode = "+" + countryCode
  return withExitCode;
}
```

--

### ‚ö†Ô∏è Smart private methods pollution.


---
class: codeonly

```java
private String countryCodeWithExitCode(String countryCode) {
  var hasOnlyDigits = CharMatcher
          .inRange('0', '9')
          .matchesAllOf(countryCode);
  checkArgument(hasOnlyDigits, "Country code must only contain digits, but was %s", countryCode);
  var withExitCode = "+" + countryCode
  return withExitCode;
}
```

--

### üí° Principle: extract classes hiding as methods

--

```java
class CountryCode {

  private final String code;

  CountryCode(String code) {
      this.code = withoutExitCode(code);
      var hasOnlyDigits = CharMatcher
              .inRange('0', '9')
              .matchesAllOf(code);
      checkArgument(hasOnlyDigits, "Country code must only contain digits, but was %s", code);
  }

  private String withoutExitCode(String code) {
      return code.replace("+", "");
  }

  public String withExitCode() {
      return "+" + this.code;
  }
}
```

---
class: codeonly

```java
Stream<User> users = repository.allUsers();
  users
          .flatMap(this::phoneNumbers)
          .map(PhoneNumber::countryCode)
*         .map(this::countryCodeWithExitCode)
          .forEach(System.out::println);
```

--

```java
Stream<User> users = repository.allUsers();
  users
          .flatMap(this::phoneNumbers)
          .map(PhoneNumber::countryCode)          
*         .map(CountryCode::new)
*         .map(CountryCode::withExitCode)
          .forEach(System.out::println);
```

--

```java
Stream<User> users = repository.allUsers();
  users
          .flatMap(this::phoneNumbers)
          .map(PhoneNumber::countryCode)          
*         .map(CountryCode::withExitCode)
          .forEach(System.out::println);
```



---
class: codeonly
### üí° Principle: maximum proximity, minimum visibility.
### 1. internal class
### 2. internal static class
### 3. package-private class
### 4. public class
### 5. separate package
???
to express belonging.


---
class: codeonly
### **implicit conversion**

```java
class BitcoinExchange {
    BitcoinExchange(BitcoinExchange.Rate rate) {
        this.rate = rate;
    }
    void sell(Bitcoin btc) { ... rate.decimal() ... }
    void buy(Bitcoin btc) { ... rate.decimal() ... }

    @FunctionalInterface
    interface Rate {
        BigDecimal decimal();
    }
}
```

--
```java
class Coinbase {
    public BigDecimal exchangeRate() {
        return remoteApi.fetchExchangeRate();
    }
}
```

--

```java
var coinbase = new Coinbase();
```
--

```java
*var exchange = new BitcoinExchange(coinbase::exchangeRate);
```

### ‚ô•Ô∏è No need to implement `BitcoinExchange.Rate`

---

class: center, middle, codeonly
## üí° Rule: functional interfaces simplifies system extension.
### (Interface Segregation Principle)
???
this way you can eliminate factories, wrappers.

---
class: codeonly
### üí° Interface Segregation Principle: **slim** over **FAT** interfaces

.crap[
```java
interface ProductService {
  ProductConfiguration configuration();
  AffiliateFees affiliateFees();
  Limits investmentLimits(Newcomer newcomer);
  Limits investmentLimits(Investor investor);
}
```
]

--

.crap[
```java
class DefaultProductService implements ProductService {
  DefaultProductService(..., ..., ..., ..., ..., ..., ü§¨)
}
```
]

#### üî¥ Low cohesion.

--

#### üî¥ Fat implementation.

--

#### üî¥ High afferent (inward) and efferent (outward) coupling.

--

#### üî¥ All-or-nothing implementation.

--

#### üî¥ Gives no hints: **new Investor(ProductService)** vs. **new Investor(InvestmentLimits)**

--

#### üü¢ Easier to use (Fa√ßade)

---
class: codeonly

#### üí° Reification (implicit -> explicit)

.crap[
```java
if (productsOwnedByPo.get(po.id()).containsKey(product.id())) {
  ...
}
```
]

--

.nice[
```java
if (productOwner.owns(product)) {
  ...
}
```
]

--

.crap[
```java



Collection<Boolean> checkboxes = new ArrayList<>();
```
]

--

.nice[
```java
Collection<Checkbox> checkboxes = ...
```
]

--

.crap[
```java



interface EShop {
    Map<String, String> resolveAffiliates(EShopSession session);
}
```
]

--

.nice[
```java
interface EShop {
    Affiliates affiliates(EShopSession session);
}
```
]

--

.nice[
```java
@AimForThis
interface EShopSession {
    Affiliates affiliates();
}
```
]

---
class: codeonly
.crap[
```java
MultivaluedMap<String, String> formParams = new Form();
for (String key : params.keySet()) {
    formParams.add(key, params.get(key));
}
```
]

--

.crap[
```java
Form form = new Form();
for (String key : params.keySet()) {
    form.add(key, params.get(key));
}
```
]

--

.nice[
```java
Form form = new Form(new Parameters(params));
```
]

--

.nice[
```java
Form form = new Form();
form.parameterize(new Parameters(params));
```
]

--

.nice[
```java
Form form = new Form();
form.with(Parameters.from(httpRequest));
```
]

---
class: codeonly
.crap[
```java
class ValidationFacade {
    public boolean validateAnswers(Map<String, String> questionToAnswerMap) {
      // we always get 4 answers
      return MapUtils.isNotEmpty(questionToAnswerMap) && questionToAnswerMap.size() == 4;
    }
}
```
]

--

.nice[
```java
class Answer {
    String questionId;
    String answerId;
}
```
]

--

.crap[
```java
class ValidationFacade {
    public boolean validateAnswers(Collection<Answer> answers) {
      // we always get 4 answers
      return answers.size() == 4;
    }
}
```
]

--

.crap[
```java
class ValidationFacade {
    private static final int MANDATORY_NUMBER_OF_ANSWERS = 4;

    public boolean validate(Collection<Answer> answers) {
      return answers.size() == MANDATORY_NUMBER_OF_ANSWERS;
    }
}
```
]

---
class: codeonly
.nice[
```java
class UnvalidatedAnswers {

    private static final int MANDATORY_NUMBER_OF_ANSWERS = 4;
    private final Collection<Answer> answers;

    boolean areValid() {
        return answers.size() == MANDATORY_NUMBER_OF_ANSWERS;
    }
}
```
]

--

.crap[
```java
class ValidationFacade {
    public boolean validate(UnvalidatedAnswers answers) {
      return answers.areValid();
    }
}
```
]

--

.nice[
```java
@FacadeBecameObsolete
UnvalidatedAnswers answers = new UnvalidatedAnswers(...);
if (answers.areValid()) {
    ....
}
```
]

---
class: center, middle, example
# Naming
### (and how it impacts software design)

---
class: codeonly
```java
@WhatDoYouExpectToHappen
void code() {
  Entity entity ...
  dao.update(entity);
}
```

--

.crap[
```java
void update(Entity entity) {
  if (!entity.isIdAssigned()) {
    return;
  }
}
```
]

--

.nice[
```java
void update(Entity entity) {
  checkArgument(entity.isIdAssigned(), "Cannot update entity. Id is missing");
  ...
}
```
]

--

```java
void updateIfIdAssigned(Entity entity) {
  if (!entity.isIdAssigned()) {
    return;
  }
  ...
}
```

--
### üí° Principle: do or die

--

### üí° Principle: make important side-effects visible on the surface

---
class: codeonly

.crap[
```java
interface TransactionManager {
  void cancelTransaction(Transaction transaction) { ... } 
}
```
]

--

.nice[
```java
interface TransactionManager {
  void cancel(Transaction transaction) { ... } 
}
```
]

--

.crap[
```java
mergeTableCells(List<TableCell> cells)
```
]

--

.nice[
```java
merge(List<TableCell> cells)
```
]

--

.crap[
```java
interface Employee {
  String employeeAddress();
}
```
]

--

.nice[
```java
interface Employee {
  String address();
}
```
]

--

.crap[
```
String AutoClosableWindow autoClosableWindow;
```  
]

--

.nice[
```
String AutoClosableWindow window;
```  
]

--

.crap[
```
Map<Employee, Role> employeeRolesMap;
```  
]

--

.nice[
```
Map<Employee, Role> employeeRoles;
```  
]

--

.nice[
```
EmployeeRoles employeeRoles;
```  
]

--

### üí° Principle: Omit words deductable from the context.

---
class: codeonly

.crap[
```java
class Transaction {
  enum TransactionScope { }
}
```
]

--

.nice[
```java
class Transaction {
  enum Scope { }
}
```
]

--

.crap[
```java
package org.framework.batch
interface Reader { }
interface Operation { }
```
]

--

.nice[
```java
interface BatchReader { }
interface BatchOperation { }
```
]

--

.nice[
```java
interface Batch {
  interface Reader { }
  interface Operation { }
}
```
]

--

.crap[
```java
var rollbackOperation = new DatabaseRollbackOperation();
var commitOperation = new DatabaseCommitOperation();
```
]

--

.crap[
```java
var rollbackOperation = new DatabaseOperation.Rollback();
var commitOperation = new DatabaseOperation.Commit();
```
]

--

.nice[
```java
import static my.app.DatabaseOperation.*;
var rollback = new Rollback();
var commit = new Commit();
```
]

--

### üí°Principle: create context to omit unnecessary words.

---
class: codeonly

.crap[
```
var connection = new BlockingQueueDatabaseConnection();
```
]
--

.nice[
```
var connection = new ThreadSafeConnection();
```
]

--

.nice[
```
var connection = new ConcurrentConnection();
```
]

--

.crap[
```
Browser browser = ConcurrentSingletonBrowserFactory.getChromeBrowserInstance();
```
]

--

.crap[
```
Browser browser = Browsers.chrome();
```
]
--

### üí° Principle: don't leak (too many) technical details into the name.

---
class: codeonly

.crap[
```java
class Widget {
    long length();
```
]

--

.nice[
```java
class Widget {
    Pixels length();
```
]

--

.crap[
```java

interface DockerContainer {
    String spinUp();
}
```
]
--


.nice[
```java
interface DockerContainer {
    Port spinUp();
}
```
]

--

.crap[
```java

interface Jetty {
    void run(int port); // where to look for a default port?
}
```
]

--

.nice[
```java
interface Jetty {
    void run(Port port);
}
```
]

--

.nice[
```java
interface Port {
  Port DEFAULT = () -> 8080;
  int num();
}
```
]

--

### üí° Principle: use strong types to add the context and reduce discovery cost.

---
class: codeonly
### üí° Heuristic: compound names usually indicate a missing object.

.crap[
```java
interface MusicApp {
    void playMusic();
    void stopMusic();
}
```
]

--

.nice[
```java
interface Music {
    void stop();
    void play();
}
```
]

--

.nice[
```java
interface MusicApp {
    Music music(); // music.play() / music.stop()
}
```
]


.crap[
```
interface Chat {
  void sendTextMessage(String message);
  void sendMarkdownMessage(String message);
}
```  
]



--

.nice[
```
interface Chat {
  void send(TextMessage message);
  void send(MarkdownMessage message);
}
```  
]

--

.crap[
```java
borrower.loanAgreement();
```
]

--

.nice[
```java
borrower.loan().agreement();
```
]

---
class: center, middle
# Methods are either **commands** or **queries**.
### Use commands (verbs) to tell an object what to do.
### Use queries (nouns) to ask object give you something.
‚Äî *[Command/Query Separation](http://martinfowler.com/bliki/CommandQuerySeparation.html)*

---
class: codeonly
.crap[
```java
interface Iterator<T> {
  T next();
```
]

--

.nice[
```java
interface Iterator<T> {

  // command to tell an object what to do (verb)
  void advance();

  // query to ask for state (noun)
  T current();
```
]

--

.crap[
```java



InputStream stream = webPage.crawl();
```
]

--

.nice[
```java
InputStream stream = webPage.content(); // under the hood, an object might do something big!
```
]

--

.crap[
```java
webPage.crawl().transferTo(...)
```
]

--

.nice[
```java
webPage.content().transferTo(...)
```
]

--

.crap[
```java


user.getFullName(); // if (user.getFullName().equals(...))
```
]

--

.nice[
```java
user.fullName();    // if (user.fullName().equals(...))
```
]

--

.crap[
```java


transaction.getCurrent().pointsTo(...)
```
]

--

.nice[
```java
transaction.current().pointsTo(...)
```
]

---
class: codeonly, middle, center

## üí° CQS is easy in 50% of cases. In 40% cases it reveals poor object design. In 10% cases should be violated.

---
class: codeonly, center, middle
# Object Design

---
class: codeonly

### Procedural

--

.crap[
```java
class FtpUtils {

  void transferFile(File file, File newLocation)

  boolean fileExists(String filename);

  void makeDir(String parentDir, String dir);

  boolean folderExists(String folder);
```
]

--

### Object-Oriented

.nice[
```java
class FtpFolder {

  void createIn(FtpFolder parent);

  boolean exists();
```
]

--

.nice[
```java

class FtpFile {

  void transferTo(FtpFolder destination)

  boolean exists();
```
]

---
class: codeonly

### üí° Good object design eliminate meaningless **agent nouns**.

```java
class *Helper
```

--

```java
class *Utils
```

--

```java
class *Processor
```



--

```java
class *Manager
```

--

```java
class *Service
```

--

```java
class ending with *er or *or
```

--

.crap[
```java
countryResolver.resolve(user);        // üî¥ country resolver's resolve?
```
]

--

.crap[
```java
countryResolver.country(user);        // üî¥ country resolver's country?
```
]

--

.nice[
```java
user.country();                       // üü¢ user's country
```
]

--

.nice[
```java
new Country(user);                    // üü¢ user's country
```
]

--

.nice[
```java
Country.of(user);                     // üü¢ user's country
```
]


---
class: codeonly
.crap[
```java
interface FileSystem {
    String read(File file);              // üî¥ read the filesystem using a file?
```
]

--

.crap[
```java
interface FileSystem {
  String content(File file);             // üî¥ file system's content?
```
]

--

.nice[
```java
var file = new File(location);
var content = file.content();            // üü¢ file's content
```
]

--

.nice[
```java
var content = new FileContent(location); // üü¢ OO design made right
```
]

--
.crap[

```java

interface FileSystem {
    boolean isEmpty(File file);          // üî¥ is filesystem empty?
```
]

--

.nice[
```java
class File {
    boolean isEmpty();                   // üü¢ is file empty?
```  
]

---
class: codeonly

### üí° Good object design reduces coupling with encapsulation (tell, don't ask)

.crap[
```java
interface EmailSender {
  void send(Email email); // email sender must know everything about the email's internals :(
```
]

--

.nice[
```java
interface Email {
  void deliver();
```]

--

.crap[
```java

interface ConditionChecker {
  boolean checkCondition(Condition condition)
```
]

--

.nice[```java
interface Condition {
  boolean isFulfilled();
```
]

--

.crap[
```java

interface CredentialValidator {
  boolean validate(String username, String password);
```
]

--

.nice[```java
interface Credentials {
  boolean areValid();
```
]

--

.crap[
```java

interface RegistrationService {
  void register(String username, String password);
```
]

--

.nice[
```java
interface Registration {
  void complete();
```
]

---
class: codeonly

### üí° Good object design reduces number of parameters

--

```java
class File { }
```

--

.crap[
```java
class FileReader {

   String read(File file) { ... }
   

```
]

--
  
.crap[
```java
   boolean hasText(File file) { ... }
```
]

--
  
.crap[
```java
   Stream<String> lines(File file) { ... }
```
]

--
  
.crap[
```java
   String read(Path path) { ... }

   boolean hasText(Path path) { ... }

   Stream<String> lines(Path path) { ... }
```
]

--

.nice[
```java

class TextFile {

   TextFile(Path) { ... }
   TextFile(File) { ... }
```
]

--

.nice[
```java
   String text();
```
]

--

.nice[
```java
   boolean isEmpty();
```
]

--

.nice[
```java
   Stream<String> lines();
```
]

---
class: center, middle
# .json()
### (demo)


---
class: codeonly

### üí° Good object design denies setters. Objects are not data bags.

.crap[
```java
Borrower borrower = new Borrower();
borrower.setFirstName(firstName);
borrower.setLastName(lastName);
```
]

--

.nice[
```java
borrower.change(ProfileInfo profileInfo);
```
]

--

.crap[
```java
agreement.setSigned(boolean signed);
agreement.setOwner(Borrower borrower);
```
]

--

.nice[
```java
agreement.sign(Borrower borrower);
```
]

--

.nice[
```java
agreement.callOff();
```
]

--

.nice[
```java
agreement.suspendFraudulent();
```
]

--

.crap[
```java
user.setIpAddress(String ipAddress);
```
]

--

.nice[
```java
user.register(RegistrationInfo registrationInfo);
```
]

--

.nice[
```java
user.visitWebsite(GeoLocation location);
```
]

--

.nice[
```java
loanApplication.isADrunkDecision(LendingPolicy lendingPolicy);
```
]

#### üí° Hint: objects can have dependencies (hello, Domain-Driven Design)
#### üí° Hint: objects should protect their invariants.

---
# Data classes

--

## - DTOs, Java beans...

--

## - do not have behaviour, hence have no tests.

--

## - **can** have getters and setters (but should they?)

---
class: codeonly
```java
class User {
    private final String firstName;
    private final String lastName;
    private String middleName;

    public User(String firstName, String lastName) {
        ...
    }

    // getters and a setter for middleName

    @Override
    public String toString() {
        return "User{" +
                "firstName='" + firstName + '\'' +
                ", lastName='" + lastName + '\'' +
                ", middleName='" + middleName + '\'' +
                '}';
    }

    @Override
    public boolean equals(Object o) {
        if (this == o) return true;
        if (o == null || getClass() != o.getClass()) return false;
        User user = (User) o;
        return Objects.equals(firstName, user.firstName) &&
                Objects.equals(lastName, user.lastName) &&
                Objects.equals(middleName, user.middleName);
    }

    @Override
    public int hashCode() {
        return Objects.hash(firstName, lastName, middleName);
    }
}
```

---
class: codeonly
```java
class User {
    public final String firstName;
    public final String lastName;
    public String middleName;

    public User(String firstName, String lastName) {
        ...
    }

    @Override
    public String toString() {
        return "User{" +
                "firstName='" + firstName + '\'' +
                ", lastName='" + lastName + '\'' +
                ", middleName='" + middleName + '\'' +
                '}';
    }

    @Override
    public boolean equals(Object o) {
        if (this == o) return true;
        if (o == null || getClass() != o.getClass()) return false;
        User user = (User) o;
        return Objects.equals(firstName, user.firstName) &&
                Objects.equals(lastName, user.lastName) &&
                Objects.equals(middleName, user.middleName);
    }

    @Override
    public int hashCode() {
        return Objects.hash(firstName, lastName, middleName);
    }
}
```

---
class: codeonly
```java
class User {
    public final String firstName;
    public final String lastName;
    public String middleName;

    public User(String firstName, String lastName) {
        ...
    }

    @Override
    public String toString() {
        return ToStringBuilder.reflectionToString(this);
    }

    @Override
    public boolean equals(Object o) {
        if (this == o) return true;
        if (o == null || getClass() != o.getClass()) return false;
        User user = (User) o;
        return Objects.equals(firstName, user.firstName) &&
                Objects.equals(lastName, user.lastName) &&
                Objects.equals(middleName, user.middleName);
    }

    @Override
    public int hashCode() {
        return Objects.hash(firstName, lastName, middleName);
    }
}
```

---
class: codeonly
```java
class User {
    public final String firstName;
    public final String lastName;
    public String middleName;

    public User(String firstName, String lastName) {
        ...
    }

    @Override
    public String toString() {
        return ToStringBuilder.reflectionToString(this);
    }

    @Override
    public boolean equals(Object o) {
        return EqualsBuilder.reflectionEquals(this, that);
    }

    @Override
    public int hashCode() {
        return HashCodeBuilder.reflectionHashCode(this);
    }
}
```

---
class: codeonly
```java
class User extends Data {
    public final String firstName;
    public final String lastName;
    public String middleName;

    public User(String firstName, String lastName) {
        ...
    }

}
```

--
```java
  User user = new User("Robert", "Martin");
  user.middleName = "Cecil"
```

--

### üí° Alternatives:
#### - github.com/rzwitserloot/lombok
#### - github.com/immutables/immutables
#### - records (still preview in Java 15)

---
class: center, middle, example
# Tony Hoare's billion dollar mistake

---
class: center, middle
## If nulls are possible, make them explicit. Rely on compiler to catch missing null checks.

---

class: codeonly
```kotlin

plugins {
  java
  id("net.ltgt.errorprone") version "0.8.1"
}

dependencies {
  errorprone("com.google.errorprone:error_prone_core:2.3.3")
  errorprone("com.uber.nullaway:nullaway:0.7.5")
}
```

--

```java
public String greet() {
  greetings(null);
  return null;
}

public String greetings(String name) {
  return "Hello, " + name;
}
```

--

```whatever

[NullAway] returning @Nullable expression from method with @NonNull return type
1 warning

[NullAway] passing @Nullable parameter 'null' where @NonNull is required
1 warning
```

---
class: center, middle
## In new code, use optionals.

---
class: codeonly
.crap[
```java
@ReturnsNullIfNumberIsNotFound
interface PhoneBook {
  PhoneNumber phoneNumber(String regex);
}
```
]

--

.nice[
```java
interface PhoneBook {
  Optional<PhoneNumber> phoneNumber(String regex);
}
```
]

--

```java
void ifPresent() {
  Optional<PhoneNumber> phoneNumber = phoneBook.phoneNumber(...);
  phoneNumber.ifPresent(paymentReminder::send);
}
```

--

```java
void orElse() {
  PhoneNumber phoneNumber = phoneBook.phoneNumber(...)
      .orElse(PhoneNumber.USA_PRESIDENT);
}
```

--

```java
void orElseThrow() {
  PhoneNumber phoneNumber = phoneBook.phoneNumber(...)
      .orElseThrow(() -> new PhoneNumberLookupFailed(regex)
}
```

---

class: codeonly
.crap[
```java
PhoneNumber phoneNumber = phoneBook.phoneNumber(...);
if (phoneNumber != null) {
  FacebookProfile facebookProfile = facebook.profile(phoneNumber);
  if (facebookProfile != null) {
    Picture picture = facebookProfile.picture();
    if (picture != null) {
      picture.download();
    }
  }
}
```
]

--

.nice[
```java
phoneBook.phoneNumber(...)
    .flatMap(facebook::profile)
    .flatMap(FacebookProfile::picture)
    .ifPresent(ProfilePicture::download);
```
]

---
class: codeonly

.crap[
```java
class Entrepreneur {
  private String fullName;
  private Optional<Money> money;

  Entrepreneur(String fullName, Optional<Money> money) {
      this.fullName = fullName;
      this.money = money;
  }
}
```
]

--

.nice[
```java
class Entrepreneur {
  private String fullName;
  private Optional<Money> money = Optional.empty();

  Entrepreneur(String fullName) {
      this.fullName = fullName;
  }

  void earn(Money money)
    this.money = Optional.of(money);
  }
}
```
]

---
class: codeonly
```java
@RegexIsOptional
interface PhoneBook {
  Collection<PhoneNumber> phoneNumbers(String regex);
}
```

--

```java
interface Mask {

  Mask ANY = phoneNumber -> true;

  boolean matches(PhoneNumber phoneNumber);
}
```

--

```java
class Regex implements Mask {

  private final Pattern regex;

  @Override
  public boolean matches(PhoneNumber phoneNumber) {
    return regex.asPredicate().test(phoneNumber.toString());
  }
}
```

--

```java
interface PhoneBook {
  Collection<PhoneNumber> phoneNumbers(Mask mask);
}```

--

```java
phoneBook.phoneNumbers(Mask.ANY);

phoneBook.phoneNumbers(new Regex(...));

```

---
class: center, middle
## Null Object pattern.


---
class: codeonly

.crap[
```java
class Application {
  private Banner banner;

  public void boot() {
    if (banner != null) {
      banner.print();
    }
  }
```
]

--

.nice[
```
  class NoBanner implements Banner {
    @Override
    public void print() {
      logger.info("Banner has not been set. You can set it via application.banner property.")
    }
  }
```
]

--

.nice[
```java
class Application {
* private Banner banner = new NoBanner();

  public void boot() {
    if (banner != null) {
      banner.print();
    }
  }
```
]

--

.nice[
```java
class Application {
  private Banner banner = new NoBanner();

  public void boot() {
*     banner.print();
  }
```
]

---

class: center, middle
# üë®‚Äçüíª üë©‚Äçüíª bit.ly/java_practice

---
class: middle, center, example
# Growth control.
### ... because we want to keep object's behaviour next to the state

---
class: center, middle
# Pattern I: Object mother.

---
class: codeonly
```java
public class Tweet {

    private LocalDate date = LocalDate.now();

    private Collection<Like> likes = new LinkedList<>();

    public LocalDate date() {
        return date;
    }

    public Collection<Like> likes() {
        return ImmutableList.copyOf(likes);
    }

    public void like(Like like) {
        likes.add(like);
    }

    public long totalLikes() {
        return likes.size();
    }

    public void deleteBy(LikeId id) {
        var like = likes.stream().filter(like => like.hasId(id)).findFirst()

        checkState(like.comesFrom(App.me()), "You can only delete your own likes");
        checkState(!like.isOlderThan(days(3)), "You can only delete likes no older than 3 days");
        
        likes.remove(like);
   }
```

---
class: codeonly
```java
public class Tweet {

    private LocalDate date = LocalDate.now();

    private Collection<Like> likes = new LinkedList<>();

    public LocalDate date() {
        return date;
    }

    public Likes likes() {
        return new Likes();
    }

    class Likes {

        public void put(Like like) {
            likes.add(like);
        }

        public long total() {
            return likes.size();
        }

        public Collection<Like> all() {
          return ImmutableList.copyOf(likes);
        }

        public void deleteBy(LikeId id) {
          var like = likes.stream().filter(like => like.hasId(id)).findFirst()

          checkState(like.comesFrom(App.me()), "You can only delete your own likes");
          checkState(!like.isOlderThan(days(3)), "You can only delete likes no older than 3 days");

          likes.remove(like);
        }
    }
}
```

---
class: codeonly
```java
public class Tweet {

    private LocalDate date = LocalDate.now();

    private Collection<Like> likes = new LinkedList<>();

    public LocalDate date() {
        return date;
    }

    public Likes likes() {
        return new Likes();
    }

    class Likes extends ForwardingList<Like> {

        @Override
        protected List<Like> delegate() {
            return likes;
        }

        public void deleteBy(LikeId id) {
          var like = likes.stream().filter(like => like.hasId(id)).findFirst()

          checkState(like.comesFrom(App.me()), "You can only delete your own likes");
          checkState(!like.isOlderThan(days(3)), "You can only delete likes no older than 3 days");
          
          likes.remove(like);
        }
    }
}
```

---
class: center, middle
# Pattern 2: Decomposition.

---
class: center, middle
## Total likes during Black Friday?

---
class: codeonly
```java
class BlackFriday {
```

--

```java
    public boolean fallsOn(LocalDate date) {
        var blackFriday = thanksgiving.plusDays(1);
        return blackFriday.isEqual(date);
    }
```

--

```java
    private LocalDate thanksgiving() {
        return LocalDate
          .now()
          .with(Month.NOVEMBER)
          .with(TemporalAdjusters.lastInMonth(THURSDAY));
    }
}
```

--

```java
class Likes {
    ...
    public long totalDuring(BlackFriday blackFriday) {
        return likes
            .stream()
            .map(Like::date)
            .filter(blackFriday::fallsOn)
            .count();
    }
    ...
}
```


---
class: center, middle
# Pattern III: Queries.


---
class: codeonly
```java
@FunctionalInterface
interface Query<T, R> {
    R result(T entity);
}
```

--

```java
public interface Entity<T> {
    default <R> R __(Query<T, R> query) {
        return query.result((T) this);
    }
}
```

--

```java
class Likes implements Entity<Likes> {
  ...
}
```

--

```java
class TotalDuringBlackFriday implements Query<Tweet.Likes, Long> {

    private final BlackFriday blackFriday = new BlackFriday();

    @Override
    public Long of(Tweet.Likes likes) {
        return
          likes
            .stream()
            .map(Like::date)
            .filter(blackFriday::fallsOn)
            .count();
    }
}
```

--

```java
Tweet tweet = ...
Tweet.Likes likes = tweet.likes();
long total = likes.__(new TotalDuringBlackFriday());
```
???
- must side effect free!
- btw, can be written inline, as lambdas
- PACKAGING MATTERS! under .likes


---
class: center, middle
# Pattern IV: Specifications.

---
class: codeonly
```java

@FunctionalInterface
interface Specification<T> {
    boolean isSatisfiedBy(T entity);
}
```

--

```java
public interface Entity<T> {
    default <R> R __(Query<T, R> query) {
        return query.result((T) this);
    }

    default boolean __(Specification<T> specification) {
        return specification.isSatisfiedBy((T) this);
    }
}
```

--

```java
class GotMillionLikesOnAPostingDay implements Specification<Tweet> {

        @Override
        public boolean isSatisfiedBy(Tweet tweet) {
            long likesOnAPostingDay = tweet
                    .likes()
                    .stream()
                    .filter(like -> like.isGivenOn(tweet.date()))
                    .count();
            return likesOnAPostingDay >= 1000000;
        }
    }
```

--
```java
Tweet tweet = ...
boolean milionLikesInADay = tweet.__(new GotMillionLikesOnAPostingDay());
```

---

class: center, middle
# Pattern V: Roles

---
class: codeonly
### üí° An object can have different representations (roles) in the system.
### üí° In Hibernate, you can map one row to many entities.

--

#### `org.system.client.Client` üß≤

#### vs.

--

#### `org.system.web.WebsiteVisitor` (ipAddress, location)
#### `org.system.lending.Applicant` (applications)
#### `org.system.lending.Borrower` (loans)
#### `org.system.lending.RecurringBorrower` (multiple loans, rules for recurring borrowers)
#### `org.system.lending.notification.Subscriber` (email, settings)
#### `org.system.deco.Insolvent` (insolvency date, insolvency reason)

---
class: center, middle
# [Part II](part_2.html)

    </textarea>
    <script src="https://code.jquery.com/jquery-2.2.4.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/remark/0.14.0/remark.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/10.2.0/highlight.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/10.2.0/languages/java.min.js"></script>
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.6.0/katex.min.js"></script>
    <script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
    <script>
      var slideshow = remark.create({
        highlightLines: true,
        highlightLanguage: 'java',
        click: true,
        touch: true
      });
      slideshow.on('afterShowSlide', function (slide) {

        var axs =  {
                  title: 'thoughput / responsiveness over time.',
                  xaxis: {
                    title: 'time (months)'
                  },
                  yaxis: {
                    title: 'throughput / responsiveness (RTF / sprint)'
                  }
                }

        var thr = [
                {
                  x: [2, 10, 14, 24, 40],
                  y: [30, 29, 28, 23, 10],
                  name: 'continuous degradation',
                  mode: 'lines',
                  line: {
                      color: 'rgb(219, 64, 82)',
                      width: 3
                    }
                },
                {
                  x: [2, 6, 12, 24, 48],
                  y: [30, 30, 30, 30, 30],
                  name: 'sustainable pace',
                  mode: 'lines',
                  line: {
                      color: 'rgb(169, 169, 169)'
                  }
                },
                {
                  x: [2, 6, 12, 24, 48],
                  y: [30, 30.5, 31, 31.5, 32],
                  name: 'continuous improvement',
                  mode: 'lines'
                },
          ];

          var dbt = thr.concat({
                  x: [28, 28],
                  y: [30, 20],
                  name: 'technical debt',
                  mode: 'lines',
                  line: {
                    dash: 'dot'
                  }
                } );

        if (slide.properties.name == "throughput") {
          Plotly.newPlot('throughput', thr, axs);
        }
        if (slide.properties.name == "debt") {
          Plotly.newPlot('debt', dbt, axs);
        }
      });

    var ktx = document.getElementsByClassName("ktx");
    for(var i = 0; i < ktx.length; i++) {
       katex.render(ktx.item(i).getAttribute('expr'), ktx.item(i));
      }
    </script>

  </body>
</html>
