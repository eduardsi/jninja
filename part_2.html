<!DOCTYPE html>
<html>
  <head>
    <title>Title</title>
    <meta charset="utf-8">
    <link rel="stylesheet" href="ocean.css" />
    <style>
      @import url(https://fonts.googleapis.com/css?family=Yanone+Kaffeesatz);
      @import url(https://fonts.googleapis.com/css?family=Droid+Serif:400,700,400italic);
      @import url(https://fonts.googleapis.com/css?family=Ubuntu+Mono:400,700,400italic);

      body { font-family: 'Droid Serif'; }
      h1, h2, h3 {
        font-family: 'Yanone Kaffeesatz';
        font-weight: normal;
      }
      /* new */
      .example { background-color: #007ebc}
      .example h2 { color: #00394f; font-weight: bold; line-height: 0;}
      .example h1 { color: #fff; font-weight: bold; background-color: #00394f; padding: 10px }

      .codeonly { padding: 1em; background-color: #2b303b }
      .codeonly pre { margin: 0 }

      .remark-code-line-highlighted { background-color: #2d9967; color: white}
      .remark-code-line-highlighted * { color: white !important; }

      .remark-slide-scaler { -webkit-box-shadow: 0 !important; box-shadow: none !important; }
      .remark-slide-container {background-color: #2b303b}
      /* new end */
      .fade {color: #E0E0E0}
      .spanny { padding: 10px; color: white; background-color: #0b1c2e }
      .nopadding { padding: 0 }
      .libs { background-color: #202020}
      .l50 { float: left; width: 50%; }
      .r50 { float: right; width: 50%; }
      .crap pre { border-right: 5px solid #D81F2A; }
      .nice pre { border-right: 5px solid #69F0AE; }

      .corner {border: 5px solid #85C1E9; position: absolute; top: 0px; right: 0px; width: 50%; background-color: #F0F0F0}
      .corner pre {margin: 0; padding: 0}
      .corner.long {height: 300px;}

      .remark-code, .remark-inline-code { font-family: 'Ubuntu Mono'; }
      .invert { background-color: black; color: white; }
      .bad { background-color: #AA1914; color: white;}
      .oki { background-color: #3D9972; color: white;}
      .strike { text-decoration: line-through; }
      .lint { background-color: #f3f3f3; }
      .conversation h3 { margin: 17px; font-size: 28px; }
    </style>
  </head>
  <body>
    <textarea id="source">

class: center, middle

# Part II

---
class: center, middle, example
# Application aka Service layer

---
## - defines a use case, what the system does

--

## - defines a use case contract (input / output)

--

## - defines transaction boundary

--

## - never ever to be confused with a domain service

---
class: codeonly

.crap[
```java
interface MemberPermissionService {

  void grantPermission(String memberId, String permissionId);

  PermissionsDto listPermissions(String memberId);

}
```
]

--

.crap[
```java
@Transactional
class MemberPermissionServiceImpl implements MemberPermissionService {

  @Override
  public void grantPermission(String memberId, String permissionId) { ... }

  @Override
  public PermissionsDto listPermissions(String memberId) { ... }

}
```
]

---
class: bad

## - tend to grow like hell

---
class: codeonly
.nice[
```java
class GrantPermission implements Command<Voidy> {

    public final String memberId, permissionId;

    public GrantPermission(String memberId, String permissionId) { ... }
}
```
]

--
.nice[
```java
class GrantPermissionHandler implements Command.Handler<GrantPermission, Voidy> {

    private final Members members;
    private final Permissions permissions;

    public GrantPermissionReaction(Permissions permissions, Members members) { ... }

    @Override
    public Voidy handle(GrantPermissionCommand $) {
        Member member = members.singleBy($.memberId);
        Permission permission = permissions.singleBy($.permissionId);

        member.grant(permission);
        return new Voidy();
    }
}
```
]

---
class: codeonly
.nice[
```java
@Configuration
class PipelinrConfiguration {

    @Bean
    Pipeline pipeline(ObjectProvider<Command.Handler> commandHandlers, 
                      ObjectProvider<PipelineStep> pipelineSteps) {
        return new Pipelinr(commandHandlers::stream, pipelineSteps::orderedStream);
    }
}
```
]

--
class: codeonly
```java
@RestController
class GrantPermissionEndpoint {

    @Autowired
    Pipeline pipeline;

    @PostMapping("/users/{memberId}/permissions")
    Voidy accept(@PathVariable String memberId, @RequestParam String permissionId) {
        var grantPermission = new GrantPermission(memberId, permissionId);
        return pipeline.send(grantPermission);
    }
```

---
class: bad

## - ~~tend to grow like hell~~

## - no dynamic routing



---
class: codeonly

```java
class LegacyBecomeAUserHandler implements Command.Handler<BecomeAUser, Voidy> {

    @Override
    public boolean matches(BecomeAUser command) {
        return command.user.registrationDate.isBefore(migrationDate) ||
               command.user.registrationDate.isEqual(migrationDate)
    }

    ...
}

class NewBecomeAUserHandler implements Command.Handler<BecomeAUser, Voidy> {
    
    @Override
    public boolean matches(BecomeAUser command) {
        return command.user.registrationDate.isAfter(migrationDate);
    } 

    ...
}
```

---
class: bad

## - ~~tend to grow like hell~~

## - ~~no dynamic routing~~

## - hard to plug-in without proxy magic


---
class: center, middle
## Logging?

---
class: codeonly
```java
@Component
@Order(2)
class CommandLogging implements PipelineStep {

    private final Logger log = LoggerFactory.getLogger(CommandLogging.class);

    @Override
    public <R, C extends Command<R>> R invoke(C command, Next<R> next) {
        log.info(">>> {}", command.toString());
        var response = next.invoke();
        log.info("<<< {} ", response.toString());
        return response;
    }

}
```

---
class: center, middle
## Correlation id?

---
class: codeonly

```java
@Component
class CorrelationId {

    private static final String MDC_KEY = "ccid";

    private final AtomicLong counter = new AtomicLong();

    public MDC.MDCCloseable storeForLogging() {
        return MDC.putCloseable(MDC_KEY, next());
    }

    private String next() {
        return String.valueOf(counter.incrementAndGet() % 1000);
    }

}
```

```java
@Component
@Order(1)
class Correlation implements PipelineStep {

    private final CorrelationId correlationId;

    Correlation(CorrelationId correlationId) {
        this.correlationId = correlationId;
    }

    @Override
    public <R, C extends Command<R>> R invoke(C command, Next<R> next) {
        try (var stashAutomatically = correlationId.storeForLogging()) {
            return next.invoke();
        }
    }
}
```

---
class: codeonly, invert
```
16:38:00.451 [main] INFO  CommandLogging   >>> BecomeAMember{name=Eduards} [1] 
16:38:00.451 [main] INFO  Validation       >>> Eduards has typed a strong password [1] 
16:38:00.451 [main] INFO  Registration     >>> Eduards has been registered [1] 
16:38:00.591 [main] INFO  CommandLogging   >>> GrantPermission{user=14523343,role=Superpowers} [2] 
16:38:00.692 [main] INFO  Permissions      >>> Alan has granted Superpowers permissions [2] 
16:38:00.665 [main] INFO  CommandLogging   <<< Voidy [2] 
16:38:00.590 [main] INFO  CommandLogging   <<< Voidy [1] 
```
---
class: center, middle
## Centralized Transaction management?

---
class: codeonly
```java
@Component
@Order(3)
class CommandTransaction implements PipelineStep {

    private final PlatformTransactionManager txManager;

    CommandTransaction(PlatformTransactionManager txManager) {
        this.txManager = txManager;
    }

    @Override
    public <R, C extends Command<R>> R invoke(C command, Next<R> next) {

        var tx = new TransactionTemplate(txManager);
        tx.setReadOnly(command instanceof ReadOnlyCommand);

        return tx.execute(txStatus -> next.invoke());
    }
}

public interface ReadOnlyCommand<R> extends Command<R> {
    ...
}

```

```java
class GetMobileNumbers implements ReadOnlyCommand<MobileNumbers> {

    ...

}
```



---
class: bad

## - ~~tend to grow like hell~~

## - ~~no dynamic routing~~

## - ~~hard to plug-in without proxy magic~~

--

## - always blocking

---
class: codeonly

```java
class ActiveMq {
    void enqueue(Command command) {
        ...
    }
}
```

--

```java
class Kafka {
    void publish(Command command) {
        ...
    }
}
```

--

```java
class Async {
    CompletableFuture<R> schedule(Command<R> command) {
        ...
    }
}
```

--

```java
class RxJava {
    Observable<R> observe(Command<R> command) {
        ...
    }
}
```

---
class: bad

## - ~~tend to grow like hell~~

## - ~~no dynamic routing~~

## - ~~hard to plug-in without proxy magic~~

## - ~~always blocking~~

---

## ðŸš€ github.com/sizovs/PipelinR
## ðŸš€ github.com/sizovs/PipelinR-demo

---
class: center, middle, example
# Validation (live-show)

---
class: center, middle, example
# Persistence

---
# DAO aka Data Access Object (2001)

--

### - Encapsulates access to data behind a well-defined interface

--

### - Makes client code persistence agnostic (db, ldap, rest...)

--

### - Don't do this at home:

---
class: codeonly
.crap[
```java
interface CustomerDAO {

  UUID insert(Customer customer);

  UUID insert(CustomerDTO customer);

  Customer insert(String personalId, String fullName);

  boolean saveOrUpdate(Customer customer);

  boolean updateFullname(Customer customer, String newFullName);

  boolean delete(Customer customer);

  boolean deleteByPersonalId(String personalId);

  Customer findByPersonalId(String personalId);

  Collection<Customer> findAll();

  Collection<PhoneNumber> findMobileNumbers(String personalId);

  void merge(Customer detached);

  ...
}
```
]

---
class: center, middle
# **Repository** mediates between the domain and data mapping layers using a **collection-like interface** for accessing domain objects.
### â€” *Fowler, PoEAA*

---
class: codeonly
.crap[
```java
interface CustomerDAO {
  UUID insert(Customer customer);
  UUID insert(CustomerDTO customer);
  Customer insert(String personalId, String fullName);
  boolean saveOrUpdate(Customer customer);
  boolean updateFullname(Customer customer, String newFullName);
  boolean delete(Customer customer);
  boolean deleteByPersonalId(String personalId);
  Customer findByPersonalId(String personalId);
  Collection<Customer> findAll();
  Collection<PhoneNumber> findMobileNumbers(String personalId);
  void merge(Customer detached);
  ...
}
```
]

--

```java
@VanillaImplementation
interface Customers {
  void add(Customer customer);
  void delete(Customer customer);
  Collection<Customer> all();
}
```

--

```java
@InRealWorldWeAlsoNeedCriteria
interface Customers {
  void add(Customer customer);
  void delete(Customer customer);
  Customer singleBy(Criteria criteria);  
  Collection<Customer> allBy(Criteria criteria);
}
```

---
class: center, middle
# Equality for Value Objects

---
class: center, middle
# Equality for Entities

---
class: codeonly
.crap[
```java
class Account {

    @GeneratedValue(strategy= GenerationType.AUTO)
    private Long id;

    private String iban;

    public Account(String iban) {
        this.iban = iban;
    }

    @Override
    public boolean equals(Object o) {
        if (this == o) return true;
        if (!(o instanceof Account)) return false;
        Account account = (Account) o;
        return Objects.equals(getId(), account.getId());
    }    

    @Override
    public int hashCode() {
        return Objects.hash(getId());
    }    
}
```
]

---
class: codeonly

```java
Account offshore = new Account("DZ4000400174401001050486");
```

--

```java
Collection<Account> accounts = new HashSet<>();
accounts.add(offshore);
```

--

```java
entityManager.persits(offshore);
```

--
```java
accounts.contains(offshore);
```

--

class: codeonly
.nice[
```java
class Account {

    @GeneratedValue(strategy= GenerationType.AUTO)
    private Long id;

*   private UUID uuid = UUID.randomUUID();

    private String iban;

    public Account(String iban) {
        this.iban = iban;
    }

    @Override
    public boolean equals(Object o) {
        if (this == o) return true;
        if (!(o instanceof Account)) return false;
        Account account = (Account) o;
*       return Objects.equals(uuid, account.uuid);
    }    

    @Override
    public int hashCode() {
*      return Objects.hashCode(uuid);
    }    
}
```
]
???
Benefits? Drawbacks?

---
class: right, middle
### .fade[For each type of object that needs global access, create an object that can] provide the illusion of an in-memory collection .fade[ of all objects of that type. Set up access through a well-known global interface. Provide methods to add and remove objects, which will encapsulate the actual insertion of removal of data in the data store. Provide methods that select objects based on some criteria and return fully instantiated objects or collections of objects whose attribute values meet the criteria, thereby encapsulating the actual storage and query technology. ]Provide repositories only for aggregate roots .fade[that actually need direct access. Keep the client focused on the model, delegating all object storage and access to the Repositories.]
### â€” *Evans, DDD*

---
class: center, middle
# An aggregate is a cluster of domain objects that can be treated as a single unit. Any references from outside the aggregate should only go to the aggregate root.
### â€” *Fowler, Bliki*

---
class: center, middle
# Aggregate root ensures consistency of an aggregate.

---
class: codeonly
```java
@Entity
class BankAccount {

    @Id
    private UUID id = UUID.randomUUID();

    @Enumerated(EnumType.STRING)
    private Status status = Status.OPEN;

    @Embedded
    private WithdrawalLimit withdrawalLimit = WithdrawalLimit.DEFAULT;

    @ElementCollection
    @CollectionTable(name = "BANK_ACCOUNT_TX")
    @OrderColumn("INDEX")
    private List<Transaction> transactions = new ArrayList<>();

    @Version
    private long version;

    ...

```

```java
@Embeddable
class Transaction {

    private DecimalNumber amount;

    private LocalDateTime bookedAt = LocalDateTime.now();

    @Enumerated(EnumType.STRING)
    private TransactionType type;

    ...
}
```

---
class: codeonly
```java
@Entity
class BankAccount {

    ...

    private List<Transaction> transactions = new ArrayList<>();

```

--

```java
    public DecimalNumber balance() {
        DecimalNumber totalDeposited = transactions.stream()
                .filter(tx -> tx.type().equals(DEPOSIT))
                .map(Transaction::amount)
                .reduce(new Const(0), DecimalNumber::plus);

        return transactions.stream()
                .filter(tx -> tx.type().equals(WITHDRAWAL))
                .map(Transaction::amount)
                .reduce(totalDeposited, DecimalNumber::minus);
    }
```

--

```java
    public Transaction deposit(DecimalNumber amount) {
        Domain.ensure(!isClosed(), "Cannot deposit funds to closed account.");

        Transaction depositTx = new Transaction(DEPOSIT, amount);
        transactions.add(depositTx);

        return depositTx;
    }
```

--

```java
    private boolean isClosed() {
        return status.equals(Status.CLOSED);
    }

    public void close() {
        status = Status.CLOSED;
    }
```

---
class: codeonly
```java
@Entity
class BankAccount {

    ...

    public Transaction withdraw(DecimalNumber amount) {
        Domain.ensure(!isClosed(), "Cannot withdraw funds from closed account.");

        Transaction withdrawalTx = new Transaction(WITHDRAWAL, amount);
        transactions.add(withdrawalTx);

        ensurePositiveBalance();
        ensureDailyWithdrawalLimitIsNotExceeded();

        return withdrawalTx;
    }

    private void ensurePositiveBalance() {
        Domain.ensure(balance().isPositive(),
          "Cannot withdraw more funds than available on your account.");
    }

```

---
class: codeonly
```java
@Entity
class BankAccount {

    ...

    private void ensureDailyWithdrawalLimitIsNotExceeded() {
        DecimalNumber dailyLimit = withdrawalLimit.dailyLimit();
        DecimalNumber withdrawnToday = totalWithdrawn(now());
        boolean dailyLimitExceeded = withdrawnToday.isGreaterThan(dailyLimit);
        Domain.ensure(!dailyLimitExceeded,
          "Cannot withdraw funds. Daily withdrawal limit (%s) reached.", dailyLimit);
    }

    private DecimalNumber totalWithdrawn(LocalDate bookedOn) {
        return transactions.stream()
                .filter(tx -> tx.type().equals(WITHDRAWAL))
                .filter(tx -> tx.bookedAt().toLocalDate().isEqual(bookedOn))
                .map(Transaction::amount)
                .reduce(new Const(0), DecimalNumber::plus);
    }
}
```

---
## BankAccount gives the following guarantees:

--

### - cannot create/store 1 million EUR transaction

--

### - cannot create/store tx when account is closed

--
### - cannot create/store tx that violates limits

--

### - no data corruption thanks to optimistic locking

---
class: codeonly

```java
BankAccount bankAccount = new BankAccount();

executeInTx(() -> entityManager.persist(bankAccount));

CyclicBarrier coordinator = new CyclicBarrier(2);

new Thread(() ->
    executeInTx(() ->
        entityManager
          .find(BankAccount.class, bankAccount.id())
          .close());
        coordinator.await();
    })
).start();

new Thread(() ->
    executeInTx(() ->
        entityManager
          .find(BankAccount.class, bankAccount.id())
          .deposit(new Amount(1000.00));
        coordinator.await();
    })
).start();
```

---

class: center, middle
## Effective Aggregate Design by Vaughn Vernon 
### dddcommunity.org/library/vernon_2011

---
class: center, middle
# Map aggregates by identity, not by pointer to avoid risk of modifying more than one aggregate per transaction.
### (concurrency exceptions can reach the point where the system becomes unusable)

---
class: codeonly
```java
@Entity
class TravisLog extends DomainEntity {

    @ElementCollection
    @CollectionTable(name = "TRAVIS_LOG_ENTRIES")
    private Collection<Entry> entries = new ArrayList<>();

    private LocalDateTime archivedAt;

    public void write(Entry entry) {
      this.entries.add(entry);
    }

    public void archive() {
        this.archivedAt = LocalDateTime.now();
    }
}
```

--

```java
@Entity
class Travis extends DomainEntity {

    @ManyToOne
    private TravisLog log;

    @OneToMany
    private Collection<TravisRepository> repositories = new ArrayList<>();

    public void manage(GitHubRepository gitHubRepository) {
        TravisRepository repository = new TravisRepository(gitHubRepository);
        repositories.add(repository);
        log.write(new NewRepositoryLogEntry(repository.id()))
    }
```

---
class: codeonly
```java
Travis travis = new Travis();
TravisLog travisLog = new TravisLog();
GitHubRepository gitHubRepository = new GitHubRepository();

executeInTx(() ->
  persist(travis, travisLog, gitHubRepository);
);

CyclicBarrier coordinator = new CyclicBarrier(2);

new Thread(() ->
    executeInTx(() ->
        entityManager
          .find(Travis.class, travis.id())
          .manage(gitHubRepository);
        coordinator.await();
    })
).start();

new Thread(() ->
    executeInTx(() ->
        entityManager
          .find(TravisLog.class, travisLog.id())
          .archive();
        coordinator.await();
    })
).start();
```

---
class: codeonly

```java
@Entity
class Travis extends DomainEntity {

    @ManyToOne
    private TravisLog log;

    @OneToMany
    private Collection<TravisRepository> repositories = new ArrayList<>();

    public void manage(GitHubRepository gitHubRepository) {
        TravisRepository repository = new TravisRepository(gitHubRepository);
        repositories.add(repository);
        log.write(new NewRepositoryLogEntry(repository.id()));
    }
```

--

```java
@Entity
class Travis extends DomainEntity {

*   @Embedded
*   private TravisLogId logId;

    @OneToMany
    private Collection<TravisRepository> repositories = new ArrayList<>();

    public void manage(GitHubRepository gitHubRepository) {
        TravisRepository repository = new TravisRepository(gitHubRepository);
        repositories.add(repository);
*       log.write(new NewRepositoryLogEntry(repository.id())); // woohoo, it's impossible now.
    }
```

---
background-image:url(eventual.jpg)
background-size: 50%

---
class: codeonly
```java
@Entity
class Travis extends DomainEntity {

    @Embedded
    private TravisLogId logId;

    @OneToMany
    private Collection<TravisRepository> repositories = new ArrayList<>();

    public void manage(GitHubRepository gitHubRepository) {
        TravisRepository repository = new TravisRepository(gitHubRepository);
        repositories.add(repository);
*       DomainEvents.durable().publish(new NewRepositoryAdded(logId, repository.id()));
    }
```

--

```java
@RunInASeparateTransaction
@RetryBeforePanic(times = 3)
class WriteNewRepositryLogEntry implements SideEffect<NewRepositoryAdded> {
    @Override
    public void occur(NewRepositoryAdded $) {
        TravisLog log = logs.byId($.logId());
        log.write(new NewRepositoryLogEntry($.newRepositoryId()));
    }
}
```

---
class: center, middle, example
# Stability Patterns
## Shed Load, Bulkheads, Timeouts and Circuit Breakers

---
class: center, middle
## Load Shedding and Bulkheads with Hystrix

---
class: codeonly
```java
@Component
class Pipeline implements Now {

    ...

    @Override
    public <C extends Command<R>, R extends Command.R> R execute(C command) {
        Now pipe =
*               new ConcurrencyLimited(
                        new Correlable(
                                new Loggable(
                                        new Transactional(
                                                new Reacting())))));

        return pipe.execute(command);
    }
```

---
class: codeonly
```java
private class ConcurrencyLimited implements Now {

       private final Now origin;

       Hystrix(Now origin) {
           this.origin = origin;
       }

       @Override
       public <C extends Command<R>, R extends Command.R> R execute(C command) {

         HystrixCommand.Setter commandOptions = hystrixOptions(command);
         HystrixCommand<R> hystrixCommand = new HystrixCommand<R>(commandOptions) {
               @Override
               protected R run() throws Exception {
                   return origin.execute(command);
               }
         };
         return hystrixCommand.execute();
       }
```
--

```java
       private HystrixCommand.Setter hystrixOptions(Command command) {
          int concurrencyLimit = command.concurrencyLimit().orElse(10);
          return HystrixCommand.Setter
                .withGroupKey(HystrixCommandGroupKey.Factory.asKey(command.name()))
                .andCommandKey(HystrixCommandKey.Factory.asKey(command.name()))
                .andCommandPropertiesDefaults(HystrixCommandProperties.Setter()
                      .withExecutionIsolationStrategy(SEMAPHORE)
                      .withExecutionIsolationSemaphoreMaxConcurrentRequests(concurrencyLimit));
        }
}
```

---
class: codeonly
```java
IntStream.range(1, 10).parallel().forEach(i -> {
      logOnError(()-> new Foo().execute(now));
      logOnError(()-> new Bar().execute(now));
});
```

--
```java
@TwoOutOfTenCommandsWillEndWith
com.netflix.hystrix.exception.HystrixRuntimeException:
  Foo could not acquire a semaphore for execution and no fallback available.
```

--

```java
public interface Reaction<C extends Command<R>, R extends Command.R> {

    R react(C $);

    default R fallback(C $) {
        throw new UnsupportedOperationException("No fallback available.");
    }

    ...
}
```

--

```java
class GetTotalLikesReaction implements Reaction<GetTotalLikes, TotalLikes> {

    @Override
    public TotalLikes fallback(GetTotalLikes $) {
        return new TotalLikes(10000000);
    }
```

---
class: codeonly
```java
private class HystrixGuarded implements Now {
    @Override
    public <C extends Command<R>, R extends Command.R> R execute(C command) {
        Reaction<C, R> reaction = router.route(command);

        HystrixCommand.Setter commandOptions = hystrixOptions(command);
        HystrixCommand<R> hystrixCommand = new HystrixCommand<R>(commandOptions) {
            @Override
            protected R run() throws Exception {
                return reaction.react(command);
            }

            @Override
            protected R getFallback() {
                return reaction.fallback(command);
            }

        };

        return hystrixCommand.execute();
    }
}
```

--
```java
@Override
public <C extends Command<R>, R extends Command.R> R execute(C command) {
    Now pipe =
            new Correlable(
                    new Loggable(
                            new Transactional(
                                    new HystrixGuarded())));

    return pipe.execute(command);
}
```

---

class: codeonly
```java
IntStream.range(1, 10).parallel().forEach(i -> {
      logOnError(()-> new GetTotalLikes().execute(now));
      logOnError(()-> new GetTotalShares().execute(now));
});
```

--
```java
@GetTotalLikesWillAlwaysSucceed
@TwoOutOfTenCommandsWillEndWith
@AllExceptionLeadToFallbackExcept(HystrixBadRequestException.class)
com.netflix.hystrix.exception.HystrixRuntimeException:
  GetTotalShares could not acquire a semaphore for execution and no fallback available.
```

---
class: center, middle
# Timeouts


---
class: codeonly
```java
@AllCommandsRunInTheCallingThread
@AllCallingThreadsWillBlockSoon
class GetTotalLikesReaction implements Reaction<GetTotalLikes, TotalLikes> {

    @Override
    public TotalLikes react(GetTotalLikesReaction $) {
      try {
          TimeUnit.SECONDS.sleep(30);
      } catch (InterruptedException e) {
          Thread.currentThread().interrupt();
      }
    }

```

--
```java
@NowAllCommandsRunInASeparateThreadPool
@BulkheadsOnSteroids
private HystrixCommand.Setter hystrixOptions(Command command) {
    int concurrencyLimit = command.concurrencyLimit().orElse(10);
    return HystrixCommand.Setter
            .withGroupKey(HystrixCommandGroupKey.Factory.asKey(command.name()))
            .andCommandKey(HystrixCommandKey.Factory.asKey(command.name()))
            .andCommandPropertiesDefaults(HystrixCommandProperties.Setter()
                    .withExecutionIsolationStrategy(THREAD)
                    .withExecutionTimeoutInMilliseconds(1000))
            .andThreadPoolPropertiesDefaults(HystrixThreadPoolProperties.Setter()
                    .withCoreSize(concurrencyLimit));
}
```
???
runs in a separate thread, because Hystrix must interrupt thread. You don't want to interrupt the whole request.

---
class: center, middle
# Circuit Breaking


---
class: codeonly
```java
class GetTotalLikesReaction implements Reaction<GetTotalLikes, TotalLikes> {

    @Override
    public TotalLikes react(GetTotalLikesReaction $) {
      try {
          TimeUnit.SECONDS.sleep(30);
      } catch (InterruptedException e) {
          Thread.currentThread().interrupt();
      }
    }

```

--
```java
@FallsBackImmediatelyAfterThirdAttempt
private HystrixCommand.Setter hystrixOptions(Command command) {
    int concurrencyLimit = command.concurrencyLimit().orElse(10);
    return HystrixCommand.Setter
            .withGroupKey(HystrixCommandGroupKey.Factory.asKey(command.name()))
            .andCommandKey(HystrixCommandKey.Factory.asKey(command.name()))
            .andCommandPropertiesDefaults(HystrixCommandProperties.Setter()
*                   .withCircuitBreakerSleepWindowInMilliseconds(30000)
*                   .withCircuitBreakerRequestVolumeThreshold(2)
                    .withExecutionIsolationStrategy(THREAD)
                    .withExecutionTimeoutInMilliseconds(1000))
            .andThreadPoolPropertiesDefaults(HystrixThreadPoolProperties.Setter()
                    .withCoreSize(concurrencyLimit));
}
```

---
class: center, middle
# You made it! 

---
# Awesome frameworks
.l50[
### Caffeine
### Selenide
### Testcontainers
### WireMock
### Jimfs
### Awaitility
]
.r50[
### Restassured
### AssertJ
### Fabricator
### jOOR
### ByteBuddy
### ArchUnit
]

---

# Awesome Java people
### Jakub Nabrdalik
### Jakub Pilimon
### J.B. Rainsberger
### Victor Rentea
### Venkat Subramaniam
### Lukas Eder
### Yegor Bugayenko

---
class: center, middle
# mustread.tech

---
class: center, middle
# goodreads.com

---
class: center, middle
# dev.tube

---
class: center, middle
# DevTernity

---
class: center, middle
# Final words

---
class: center, middle
# Thank you!



    </textarea>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/remark/0.14.0/remark.min.js"></script>
    <script>
      var slideshow = remark.create({
        highlightLines: true,
        slideNumberFormat: function (current, total) { return "" }
      });
    </script>

  </body>
</html>
