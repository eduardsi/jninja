<!DOCTYPE html>
<html>
  <head>
    <title>Title</title>
    <meta charset="utf-8">
    <link rel="stylesheet" href="ocean.css" />
    <style>
      @import url(https://fonts.googleapis.com/css?family=Yanone+Kaffeesatz);
      @import url(https://fonts.googleapis.com/css?family=Droid+Serif:400,700,400italic);
      @import url(https://fonts.googleapis.com/css?family=Ubuntu+Mono:400,700,400italic);

      body { font-family: 'Droid Serif'; }
      h1, h2, h3 {
        font-family: 'Yanone Kaffeesatz';
        font-weight: normal;
      }
      .large code { font-size: 1.5em }
      .large .hljs-comment { color: white !important}
      .squeez h3 { margin: 0.5em }
      .fade {color: #E0E0E0}
      .spanny { padding: 10px; color: white; background-color: #0b1c2e }
      .nopadding { padding: 0 }
      .libs { background-color: #202020}
      .l50 { float: left; width: 50%; }
      .r50 { float: right; width: 50%; }
      .crap pre { border-right: 5px solid #D81F2A; }
      .nice pre { border-right: 5px solid #69F0AE; }
      /* new */
      .example { background-color: #007ebc}
      .example h2 { color: #00394f; font-weight: bold; line-height: 0;}
      .example h1 { color: #fff; font-weight: bold; background-color: #00394f; padding: 10px }

      .codeonly h1, .codeonly h2, .codeonly h3 { color: white }
      .codeonly { padding: 1em; background-color: #2b303b }
      .codeonly pre { margin: 0 }

      .remark-code-line-highlighted { background-color: #2d9967; color: white}
      .remark-code-line-highlighted * { color: white !important; }

      .remark-slide-scaler { -webkit-box-shadow: 0 !important; box-shadow: none !important; }
      .remark-slide-container {background-color: #2b303b}
      /* new end */
      .corner {border: 5px solid #85C1E9; position: absolute; top: 0px; right: 0px; width: 50%; background-color: #F0F0F0}
      .corner pre {margin: 0; padding: 0}
      .corner.long {height: 300px;}

      .remark-code, .remark-inline-code { font-family: 'Ubuntu Mono'; }
      .invert { background-color: black; color: white; }
      .bad { background-color: #AA1914; color: white;}
      .oki { background-color: #3D9972; color: white;}
      .strike { text-decoration: line-through; }
      .lint { background-color: #f3f3f3; }
      .conversation h3 { margin: 17px; font-size: 28px; }
      .img100 img { width: 100%}
    </style>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.6.0/katex.min.css">
  </head>
  <body>
    <textarea id="source">

class: center, middle, example
# Effective Java Software Design
???
- Introduce myself and let others introduce themselves.
- Setting expectations
- Not Java 8 course

---
class: squeez
# Part I

--

## - naming &amp; OO construction

--

## - fighting nulls

--

## - fighting feature bloat

---
# Part II

--

## - application layer

--

## - tx

--

## - validation

--

## - persistence

--

## - fault tolerance

---

# Part III

--

## - Homework

--

## - Homework review

---
class: center, middle
# Part I
### let's warm up...

---
class: codeonly
.nice[
```java
@RestController
class RegistrationEndpoint {
  @PostMapping
  void post(@RequestParam String username) { ... }
}
```
]

--

.nice[
```java
class MethodArgumentNames {

  void print() {
      Method[] methods = RegistrationEndpoint.class.getDeclaredMethods();
      Arrays
          .stream(methods)
          .flatMap(method -> stream(method.getParameters()))
          .map(Parameter::getName)
          .forEach(System.out::println); // arg0 or username
  }  
}
```
]

--

### Any design smells?

---
class: codeonly
### Don't mix arrows and method references within a Monad
.nice[
```java
class MethodArgumentNames {

  void print() {
    Method[] methods = RegistrationEndpoint.class.getDeclaredMethods();
    Arrays
        .stream(methods)
*       .flatMap(this::parameters)
        .map(Parameter::getName)
        .forEach(System.out::println);
  }

  private Stream<Parameter> parameters(Method method) {
     return Arrays.stream(method.getParameters());
  }  
}

```
]

---
class: codeonly
### +1 requirement: fail fast if parameter names are not accessible

--

.nice[
```java
class MethodArgumentNames {

  void print() {
    Method[] methods = RegistrationEndpoint.class.getDeclaredMethods();
    Arrays
        .stream(methods)
        .flatMap(this::parameters)
*       .map(this::name)
        .forEach(System.out::println);
  }

  private String name(Parameter parameter) {
      boolean parameterHasAName = parameter.isNamePresent();
      checkArgument(parameterHasAName,
        "Parameter %s does not have a name. Please compile with --parameter flag", parameter);
      return parameter.getName();
  }
}
```
]

--

### Can we do any better?

---
class: codeonly

### Move code to the place it belongs to

--

.nice[
```java
class MethodArgumentNames {

  void print() {
    Method[] methods = RegistrationEndpoint.class.getDeclaredMethods();
    Arrays
        .stream(methods)
        .flatMap(this::parameters)
*       .map(ParameterName::new)
        .forEach(System.out::println);
  }

  private class ParameterName {
      ParameterName(Parameter parameter) {
          boolean parameterHasAName = parameter.isNamePresent();
          checkArgument(parameterHasAName,
              "Parameter %s does not have a name. Please compile with --parameter flag", parameter);
          this.textualName = parameter.getName();
      }
      @Override
      public String toString() {
          return this.textualName;
      }
  }
}
```
]
???
stepdown rule issue (where to put shared code)

---
class: codeonly
### **implicit conversion**

```java
class BitcoinExchange {
    BitcoinExchange(BitcoinExchange.Rate rate) {
        this.rate = rate;
    }
    void sell(Bitcoin btc) { ... rate.decimal() ... }
    void buy(Bitcoin btc) { ... rate.decimal() ... }

    @FunctionalInterface
    interface Rate {
        BigDecimal decimal();
    }
}
```

--
```java
class Coinbase {
    public BigDecimal exchangeRate() {
        return remoteApi.fetchExchangeRate();
    }
}
```

--

```java
Coinbase coinbase = new Coinbase();
```
--

```java
*BitcoinExchange exchange = new BitcoinExchange(coinbase::exchangeRate);
```

### no need to implement BitcoinExchange.Rate interface 

---

class: center, middle, codeonly
# Take-away: stick to Interface Segregation Principle. 
### @FunctionalInterface is your best friend

---
class: codeonly
```java
@FunctionalInterface
interface FileFactory {
    File newFile(String name);
}
```

--

```java
class Framework {
    Framework(FileFactory fileFactory) { ... }
}
```

--

.crap[
```java
@BeforeJava(8)
class SimpleFileFactory implements FileFactory {
    @Override
    public File newFile(String name) {
        return new File(name);
    }
}

Framework framework = new Framework(new SimpleFileFactory());
```
]

--

.crap[
```java
Framework framework = new Framework(name -> new File(name));
```
]

--

.nice[
```java
Framework framework = new Framework(File::new);
```
]
???
conclusion: factories can be partially eliminated.

---
class: codeonly
### **checked exception in lambdas**
.crap[
```java
    int from = 8000;
    int to = 9000;
    IntStream
              .rangeClosed(from, to)
              .mapToObj(Port::new)
              .filter(p -> {
                  try {
                      return p.free();
                  } catch (IOException e) {
                      throw new RuntimeException(e);
                  }
              })
              .findFirst();
```
]

--

class: codeonly

### github.com/zalando/faux-pas

.nice[
```java
    IntStream
            .rangeClosed(from, to)
            .mapToObj(Port::new)
            .filter(throwingPredicate(Port::free))
            .findFirst();
```
]

---
class: codeonly

### noexception.machinezoo.com

.nice[
```java
    IntStream
            .rangeClosed(from, to)
            .mapToObj(Port::new)
            .filter(Exceptions.sneak().predicate(Port::free))
            .findFirst();
```            
]


--

.crap[
```java



    Master master = new Master();
    Slave slave = new Slave();

    Connection connection;
    try {
        connection = master.connection();
    } catch (RuntimeException e) {
        log.warning(e);
        connection = slave.connection();
    }
```
]

--

.nice[
```java
    Connection connection = Exceptions
      .log()
      .get(master::connection)
      .orElseGet(slave::connection);
```
]

---
class: center, middle, example
# Naming

---
class: codeonly
```java
@WhatDoYouExpectToHappen
void code() {
  Entity entity ...
  dao.update(entity);
}
```

--

.crap[
```java
void update(Entity entity) {
  if (!entity.isIdAssigned()) {
    return;
  }
}
```
]

--

.nice[
```java
void update(Entity entity) {
  checkArgument(entity.isIdAssigned(), "Cannot update entity. Id is missing");
  ...
}
```
]

--

```java
void updateIfIdAssigned(Entity entity) {
  if (!entity.isIdAssigned()) {
    return;
  }
  ...
}
```

---
class: codeonly
.crap[
```java
interface Employee {
  String employeeAddress();
}
```
]

--

.nice[
```java
interface Employee {
  String address();
}
```
]

--

.crap[
```java
class Transaction {
  enum TransactionScope { }
}
```
]

--

.nice[
```java
class Transaction {
  enum Scope { }
}
```
]

--

.crap[
```java
@PackagesAreExceptionToTheRule
package org.framework.batch
interface Reader { }
interface Operation { }
```
]

--

.nice[
```java
interface BatchReader { }
interface BatchOperation { }
```
]

--

.nice[
```java
interface Batch {
  interface Reader { }
  interface Operation { }
}
```
]

---
class: codeonly
.crap[
```java
// incBy – preposition, not a noun
interface Counter {
  void increment(long incBy) { this.current += incBy }
}
```
]
???
by – PREPOSITION (followd by NOUN) in English.

--

.crap[
```java
interface Counter {
  // do we increment counter or ask counter to increment the value?
  void increment(long value) { this.current += value } 
}
```
]

--

.crap[
```java
interface Counter {
  // too generic, if working with a code when the method's signature is not visible
  void incrementBy(long value) { this.current += value } 
}
```
]

--

.nice[
```java
interface Counter {
  // finally!
  void incrementBy(long increment) { this.current += increment }
}
```
]

--

.crap[
```java
class Widget {
    private long length;
```
]

--

.crap[
```java
class Widget {
    private long lengthInPixels;
```
]

--

.nice[
```java
class Widget {
    private Pixels length;
```
]

--

.crap[
```java
interface Movie {
    void stream(Channel channel);
```
]

--

.nice[
```java
interface Movie {
    void streamInto(Channel channel);
```
]

---
class: codeonly

# Code must speak the domain language

.crap[
```java
  class BillingAgreement {
      private LocalDate creationDate;     
      private LocalDate startingDate;
```
]

--

.nice[
```java
  class BillingAgreement {
      private LocalDate creationDate; 
      private AsOfDate asOfDate;       
```
]

--

.crap[
```java
  class Payment {
      private LocalDate expectedDate;
      private Days allowedDelay;
```
]

--

.nice[
```java
  class Payment {
      private LocalDate dueDate;
      private GracePeriod gracePeriod;
```
]

--

.crap[
```java
  class Loan {
      private Customer customer;
```
]

--

.nice[
```java
  class Loan {
      private Borrower borrower;
```
]

---
class: center, middle
## Compound names usually indicate a missing root object

---
class: codeonly
```java
class AwsS3Bucket {

  private final String awsPassword;
  private final String awsLogin;
  private final String bucketName;

  public AwsS3Bucket(String awsLogin, String awsPassword, String bucketName) {
    this.awsLogin = awsLogin;
    this.awsPassword = awsPassword;
    this.bucketName = bucketName;
  }

  void create() {
    ...
  }

}
```

--

```java
class AwsCredentials {

  public final String login;
  public final String password;

  public AwsCredentials(String login, String password) {
    this.login = login;
    this.password = password;
  }
}
```

---
class: codeonly
```java
class AwsS3Bucket {

  private final AWSCredentials awsCredentials;
  private final String bucketName;

  public AwsS3Bucket(AwsCredentials awsCredentials, String bucketName) {
    this.awsCredentials = awsCredentials;
    this.bucketName = bucketName;
  }

  void create() {
    ...
  }

}
```

--

```java
class AwsAccount {

  private final AwsCredentials credentials;

  public AwsAccount(AwsCredentials credentials) {
    this.credentials = credentials;
  }

}
```

---
class: codeonly
```java
class AwsS3Bucket {

  private final AwsAccount account;
  private final String name;

  public AwsS3Bucket(AwsAccount account, String name) {
    this.account = account;
    this.name = name;
  }

  void create() {
    ...
  }

}
```

---
class: codeonly
.crap[
```java
interface SpotifyApp {
    void playMusic();
    void stopMusic();
}
```
]

--

.nice[
```java
interface Music {
    void stop();
    void play();
}
```
]

--

.nice[
```java
interface SpotifyApp {
    Music music();
}
```
]

--

class: codeonly
.crap[
```java
interface HipChat {
    void sendMessage(String channel, String mesage);
}
```
]

--

class: codeonly
.nice[
```java
interface Channel {
    void send(String message);
}
```
]

--

.nice[
```java
interface HipChat {
    Channel channel(String name);
}
```
]

---
class: codeonly

### exceptions must tell what has happened

--

.crap[
```java
class RuleException { }  
```
]

--

.crap[
```java
class RuleIncorrectlyAppliedException { }
```
]

--

.crap[
```java
class FileLockException extends ... { } 
```
]

--

.nice[
```java
class FileLockAcquisitionFailedException extends ... { } 
```
]

--

.crap[
```java
class WebDriverException extends ... { }                         
```
]

--

.nice[
```java
class WebDriverCrashedException extends ... { }                         
```
]

--

.crap[
```java
class BrowserNotSupportedException extends ... { }                         
```
]

--

.nice[
```java
class UnsupportedBrowserProvidedException extends ... { }                         
```
]

--

.crap[
```java
class InvisibleButtonException extends ... { }                         
```
]

--

.nice[
```java
class InvisibleButtonClickedException extends ... { }                         
```
]

---
class: center, middle
# Move from **f(o)** to **o.f()**

---
class: codeonly

```java
class File { }
```

--

.crap[
```java
class FileReader {
   String read(File file) { ... }
}
```
]

--

.crap[
```java
class FileReader {
   String read(File file) { ... }
   String read(Path path) { ... }   
}
```
]

--

.nice[
```java
class TextFile {
   TextFile(Path) { ... }
   TextFile(File) { ... }
   String text();
}
```
]

--

.crap[
```java
class FileReader {
   ...  
   boolean hasText(File file) { ... }
   boolean hasText(Path file) { ... }
}
```
]

--

.nice[
```java
class TextFile {
   ...
   boolean isEmpty();
}
```
]

---
class: codeonly

.nice[
```java
class TextFile {
   TextFile(Path) { ... }
   TextFile(File) { ... }
   String text();
}
```
]

--

.crap[
```java
class TextFile {
   TextFile(Path) { ... }
   TextFile(File) { ... }
   String text();
   byte[] binary();
}
```
]

--

.nice[
```java
class TextFile {
   TextFile(Path) { ... }
   TextFile(File) { ... }
   Content content();
}
```
]

.nice[
```java
class Content {
   String textual() { ... };
   byte[] binary() { ... };
}
```
]

---
class: codeonly
.crap[
```java
interface EmailSender {
  void send(Email email);
}
```
]

--

.nice[
```java
interface Email {
  void deliver();
}
```]

--

.crap[
```java
interface ConditionChecker {
  boolean checkCondition(Condition condition)
}
```
]

--

.nice[```java
interface Condition {
  boolean isFulfilled();
}
```
]

--

.crap[
```java
interface CredentialValidator {
  boolean validated(String username, String password);
}
```
]

--

.nice[```java
interface Credentials {
  boolean areValid();
}
```
]

--

.crap[
```java
interface RegistrationService {
  void register(String username, String password);
}
```
]

--

.nice[```java
interface Registration {
  void complete();
}
```
]


---
class: codeonly

.crap[
```java
class BankAccount {
  private Collection<Transaction> transactions;
  void exportTransactions(Period period, Media media) {}
}
```
]

### Any design smells?

--

.nice[
```java

class BankStatement {
  private Period period;
  void export(Media media);
}

class BankAccount {
  private Collection<Transaction> transactions;

  public BankStatement statement(Period period) {
    return new BankStatement(transactions, period);
  }
}
```
]

### Look ma, fewer parameters!

---
class: codeonly
.crap[
```java
class ProbabilityCalculator {
    BigDecimal calculate() { ... }
}

class ProbabilityUtils {
  boolean isHigh(BigDecimal decimal) { ... }
}

```
]

--

.nice[
```java
class Probability extends BigDecimal {
    Probability() { 
      calculationGoesHere();
    }
    boolean isHigh(); 

}
```
]

---
class: center, middle
# Methods are either **commands** or **queries**.
### Use commands (verbs) to tell an object what to do.
### With queries (nouns) you ask object to give something.
— *[Command/Query Separation](http://martinfowler.com/bliki/CommandQuerySeparation.html)*

---
class: codeonly
.crap[
```java
interface Iterator<T> {

  @NounWithASideAffect
  @ViolatesCqs
  T next();
}
```
]

--

.nice[
```java
interface Iterator<T> {

  @VerbThatReturnsNothing
  void advance();

  @NounThatReturnsStuff
  T current();
}
```
]

--

.crap[
```java
@VerbThatReturnsStuff
InputStream load(URL url);
```
]

--

.nice[
```java
@NounThatReturnsStuff
InputStream stream(URL url);
```
]

--

.crap[
```java
@VerbThatReturnsStuff
String read(File file);
```
]

--

.nice[
```java
@NounThatReturnsStuff
String content(File file);
```
]

---
class: codeonly

.crap[
```java
interface Document {

  BytesWritten writeInto(OutputStream output);
}
```
]

--

.nice[
```java
interface Document {

   OutputPipe output();
}
```
]

--

```java
interface OutputPipe {}

     void write();

     BytesWritten length();
}
```

---
class: center, middle
# Never use getters in your OO code.

---

## Getters are verbs

--

## Get **may** have a side effect

--

### - get married

--

### - get money from the ATM

--

### - get from A to B...

---
class: codeonly
```java
class Client {
  String fullName();
  String personalId();
}
```
???
consider readability if (client.fullName()) vs. if (client.getFullName())

--

```java
interface Iterator<T> {
  T current();
}
```

---
class: center, middle
## Blindly removing get\* prefix will remove noise, but won't make your code more object-oriented.
### **Tell, don't ask** as much as you can.


---
class: center, middle
# Never use setters in your OO code.

---
class: codeonly
.crap[
```java
Borrower borrower = new Borrower();
borrower.setFirstName(firstName);
borrower.setLastName(lastName);
```
]

--

.nice[
```java
borrower.giveName(String firstName, String lastName);
```
]

--

.nice[
```java
borrower.give(Name name);
```
]


--

.crap[
```java
borrower.setAcceptedAgreement(Agreement agreement);
```
]

--

.nice[
```java
borrower.accept(Agreement agreement);
```
]

--

.crap[
```java
agreement.setSigned(boolean agreementSigned);
```
]

--

.nice[
```java
agreement.sign();
```
]

--

.nice[
```java
agreement.callOff();
```
]

--

.crap[
```java
blog.setTags(Tag... tags);
```
]

--

.nice[
```java
blog.tag(Tag... tag);
```
]

--

.nice[
```java
conference.addSpeaker(Speaker speaker);
```
]

--

.crap[
```java
conference.accept(Speaker speaker);
```
]

--

### Wait, but why?!

---
# Data structures

--

## - DTOs, Java beans...

--

## - do not have behaviour

--

## - **can** have getters and setters (but should they?)

---
class: codeonly
```java
@QuiteALotOfNoise
class User {

    private final String firstName;
    private final String lastName;
    private String middleName;

    public User(String firstName, String lastName) {
        ...
    }

    public void setMiddleName(String middleName) ...

    @Override
    public String toString() ...

    @Override
    public int hashCode() ...

    @Override
    public boolean equals(Object that) ...
}
```

---
class: codeonly

## github.com/rzwitserloot/lombok

```java
@Data
class User {

  private final String firstName;
  private final String lastName;
  private String middleName;

}
```

--

```java
var user = new User("Joe", "Doe");
user.middleName("Ivanov");
```

---
class: center, middle, example
# Tony Hoare's billion dollar mistake

---
class: center, middle
## In computing, a null pointer has a value reserved for indicating that the pointer does not refer to a valid object. **Never pass null**. **Never return null**.

---
class: codeonly
```groovy
compile group: 'com.google.code.findbugs', name: 'jsr305', version: '3.0.1'
```

--

```java
@IsNotInheritedBySubpackages
@ParametersAreNonnullByDefault
package root;
```

--

```java
@ParametersAreNonnullByDefault
package root.subpackage;
```

--

class: img100
![](nevernull.png)


--

```java
@Override
public boolean equals(@Nullable Object obj) { ... }
```
???
- otherwise I will have to null-check all arguments, to be defensive.

---
class: img100, codeonly
![](brokennullity.png)

--

```java
@Nonnull
@TypeQualifierDefault({ElementType.METHOD, ElementType.PARAMETER})
@Retention(RetentionPolicy.RUNTIME)
public @interface NullsForbidden {
}
```

--

```java
@NullsForbidden
package wombat;
```

---
class: img100, codeonly
![](nullsworkagain.png)

---
class: codeonly
.crap[
```java
@ReturnsNullIfNumberIsNotFound
interface PhoneBook {
  PhoneNumber phoneNumber(String regex);
}
```
]

--

.nice[
```java
interface PhoneBook {
  Optional<PhoneNumber> phoneNumber(String regex);
}
```
]

--

```java
void ifPresent() {
  Optional<PhoneNumber> phoneNumber = phoneBook.phoneNumber(...);
  phoneNumber.ifPresent(paymentReminder::send);
}
```

--

```java
void orElse() {
  PhoneNumber phoneNumber = phoneBook.phoneNumber(...)
      .orElse(PhoneNumber.USA_PRESIDENT);
}
```

--

```java
void orElseThrow() {
  PhoneNumber phoneNumber = phoneBook.phoneNumber(...)
      .orElseThrow(() -> new PhoneNumberLookupFailed(regex)
}
```

---

class: codeonly
.crap[
```java
void lifeWithoutOptionals() {
  PhoneNumber phoneNumber = phoneBook.phoneNumber(...);
  if (phoneNumber != null) {
    FacebookProfile facebookProfile = facebook.profile(phoneNumber);
    if (facebookProfile != null) {
      Picture picture = facebookProfile.picture();
      if (picture != null) {
        picture.download();
      }
    }
  }
}
```
]

--

.nice[
```java
void optionalIsAMonad() {
  phoneBook.phoneNumber(...)
      .flatMap(facebook::profile)
      .flatMap(FacebookProfile::picture)
      .ifPresent(ProfilePicture::download);
}

```
]

---
class: codeonly
```java
@RegexIsOptional
interface PhoneBook {
  Collection<PhoneNumber> phoneNumbers(String regex);
}
```

--

```java
interface Mask {

  Mask ANY = phoneNumber -> true;

  boolean matches(PhoneNumber phoneNumber);
}
```

--

```java
class Regex implements Mask {

  private final Pattern regex;

  @Override
  public boolean matches(PhoneNumber phoneNumber) {
    return regex.asPredicate().test(phoneNumber.toString());
  }
}
```

--

```java
interface PhoneBook {
  Collection<PhoneNumber> phoneNumbers(Mask mask);
}```

--

```java
phoneBook.phoneNumbers(Mask.ANY);

phoneBook.phoneNumbers(new Regex(...));

```

---
class: codeonly

.crap[
```java
class Entrepreneur {
  private String fullName;
  private Optional<Money> money;

  Entrepreneur(String fullName, Optional<Money> money) {
      this.fullName = fullName;
      this.money = money;
  }
}
```
]

--

.nice[
```java
class Entrepreneur {
  private String fullName;
  private Optional<Money> money = Optional.empty();

  Entrepreneur(String fullName) {
      this.fullName = fullName;
  }

  void earn(Money money)
    this.money = Optional.of(money);
  }
}
```
]

---
class: middle, center, example
# Fighting feature bloat
### ... because we want to keep object's behaviour next to the state

---
# Qualities of a good class
???

--


### **Comprehensible** or mind-sized

--

### Small enough to lower **coupling**

--

### Large enough to maximize **cohesion**

--

### Small enough to be easy to **test** 


---
class: codeonly

```java
class *Helper
```

--

```java
class *Utils
```

--

```java
class *Processor
```



--

```java
class *Manager
```

--

```java
class *Service
```


---
class: codeonly
.crap[
```java
@TwoInterwovenConceptsAreHidingInside
@FileSuffixAndDirIndicateMissingObject
class FtpUtils {

  void transferFile(File file, File newLocation)

  boolean fileExists(String filename);

  void makeDir(String parentDir, String dir);

  boolean folderExists(String folder);

}
```
]

--

class: codeonly
.crap[
```java
@StillProcedural
class FtpClient {

  void transferFile(File file, File newLocation)

  boolean fileExists(String filename);

  void makeDir(String parentDir, String dir);

  boolean folderExists(String folder);

}
```
]

---
class: codeonly

.nice[
```java
class FtpFolder {

  void createIn(FtpFolder parent);

  boolean exists();

}
```
]

--

.nice[
```java
class FtpFile {

  void transferTo(FtpFolder destination)

  boolean exists();

}
```
]

---
class: codeonly
```java
public class Tweet {

    private LocalDate date = LocalDate.now();

    private Collection<Like> likes = new LinkedList<>();

    public LocalDate date() {
        return date;
    }

*   public Collection<Like> likes() {
*       return ImmutableList.copyOf(likes);
*   }
*
*   public void like(Like like) {
*     likes.add(like);
*   }
*
*   public long totalLikes() {
*     return likes.size();
*   }
*
*   public long totalLikesBy(AccountId accountId) {
*     return likes.stream().filter(like -> like.comesFrom(accountId)).count();
*   }
```

---
class: codeonly
```java
public class Tweet {

    private LocalDate date = LocalDate.now();

    private Collection<Like> likes = new LinkedList<>();

    public LocalDate date() {
        return date;
    }

    public Likes likes() {
        return new Likes();
    }

    class Likes {

        public void put(Like like) {
            likes.add(like);
        }

        public long total() {
            return likes.size();
        }

        public long totalBy(AccounId accoutId) {
            return likes.stream().filter(like -> like.comesFrom(accountId)).count();
        }

        public Collection<Like> all() {
            return ImmutableList.copyOf(likes);
        }
    }
}
```

---
class: codeonly
```java
public class Tweet {

    private LocalDate date = LocalDate.now();

    private Collection<Like> likes = new LinkedList<>();

    public LocalDate date() {
        return date;
    }

    public Likes likes() {
        return new Likes();
    }

    class Likes extends ForwardingList<Like> {

        public long totalBy(AccountId accountId) {
            return likes.stream().filter(like -> like.comesFrom(accountId)).count();
        }

        @Override
        protected List<Like> delegate() {
            return likes;
        }
    }
}
```

---
class: center, middle
## Total likes during Black Friday?

---
class: codeonly
```java
class BlackFriday {
```

--

```java
    public boolean fallsOn(LocalDate date) {
        return blackFriday().isEqual(date);
    }
```

--

```java
    private LocalDate blackFriday() {
        return thanksGivingDay().plusDays(1);
    }
```

--

```java
    private LocalDate thanksGivingDay() {
        return Year.now()
                .atMonth(Month.NOVEMBER)
                .with(TemporalAdjusters.lastInMonth(DayOfWeek.THURSDAY));
    }
}
```

--

```java
class Likes {
    ...
    public long totalDuring(BlackFriday blackFriday) {
        return likes
            .stream()
            .map(Like::date)
            .filter(blackFriday::fallsOn)
            .count();
    }
    ...
}
```


---
class: center, middle
# Yields


---
class: codeonly
```java
@FunctionalInterface
interface Yield<T, R> {
    R from(T entity);
}

--

public interface Entity<T> {
    default <R> R yield(Yield<T, R> yield) {
        return yield.from((T) this);
    }
}
```

--

```java
class Likes implements Entity<Likes> {
  ...
}
```

--

```java
class TotalDuringBlackFriday implements Yield<Tweet.Likes, Long> {

    private final BlackFriday blackFriday = new BlackFriday();

    @Override
    public Long from(Tweet.Likes likes) {
        return
          likes
            .stream()
            .map(Like::date)
            .filter(blackFriday::fallsOn)
            .count();
    }
}
```

--

```java
Tweet tweet = ...
Tweet.Likes likes = tweet.likes();
long total = likes.yield(new TotalDuringBlackFriday());
```
???
- must side effect free!
- btw, can be written inline, as lambdas
- PACKAGING MATTERS! under .likes


---
class: center, middle
# Specifications

---
class: codeonly
```java

@FunctionalInterface
interface Specification<T> {
    boolean isSatisfiedBy(T entity);
}

--

public interface Entity<T> {
    default <R> R yield(Yield<T, R> yield) {
        return yield.from((T) this);
    }

    default boolean satisfies(Specification<T> specification) {
        return specification.isSatisfiedBy((T) this);
    }
}
```

--

```java
class HasGottenMillionLikesOnAPostingDay implements Specification<Tweet> {

        @Override
        public boolean isSatisfiedBy(Tweet tweet) {
            long likesOnAPostingDay = tweet
                    .likes()
                    .stream()
                    .filter(like -> like.wasPutOn(tweet.date()))
                    .count();
            return likesOnAPostingDay >= 1000000;
        }
    }
```

--
```java
Tweet tweet = ...
boolean milionLikesInADay = tweet.satisfies(new HasGottenMillionLikesOnAPostingDay());
```

---
class: center, middle
# Multiple entities per row.


    </textarea>
    <script src="https://code.jquery.com/jquery-2.2.4.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/remark/0.14.0/remark.min.js"></script>
    </script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.6.0/katex.min.js"></script>
    <script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
    <script>
      var slideshow = remark.create({
        highlightLines: true,
        slideNumberFormat: function (current, total) { return "" }
      });
      slideshow.on('afterShowSlide', function (slide) {

        var axs =  {
                  title: 'thoughput / responsiveness over time.',
                  xaxis: {
                    title: 'time (months)'
                  },
                  yaxis: {
                    title: 'throughput / responsiveness (RTF / sprint)'
                  }
                }

        var thr = [
                {
                  x: [2, 10, 14, 24, 40],
                  y: [30, 29, 28, 23, 10],
                  name: 'continuous degradation',
                  mode: 'lines',
                  line: {
                      color: 'rgb(219, 64, 82)',
                      width: 3
                    }
                },
                {
                  x: [2, 6, 12, 24, 48],
                  y: [30, 30, 30, 30, 30],
                  name: 'sustainable pace',
                  mode: 'lines',
                  line: {
                      color: 'rgb(169, 169, 169)'
                  }
                },
                {
                  x: [2, 6, 12, 24, 48],
                  y: [30, 30.5, 31, 31.5, 32],
                  name: 'continuous improvement',
                  mode: 'lines'
                },
          ];

          var dbt = thr.concat({
                  x: [28, 28],
                  y: [30, 20],
                  name: 'technical debt',
                  mode: 'lines',
                  line: {
                    dash: 'dot'
                  }
                } );

        if (slide.properties.name == "throughput") {
          Plotly.newPlot('throughput', thr, axs);
        }
        if (slide.properties.name == "debt") {
          Plotly.newPlot('debt', dbt, axs);
        }
      });

    var ktx = document.getElementsByClassName("ktx");
    for(var i = 0; i < ktx.length; i++) {
       katex.render(ktx.item(i).getAttribute('expr'), ktx.item(i));
      }
    </script>

  </body>
</html>
