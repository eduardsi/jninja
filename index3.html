<!DOCTYPE html>
<html>
  <head>
    <title>Title</title>
    <meta charset="utf-8">
    <style>
      @import url(https://fonts.googleapis.com/css?family=Yanone+Kaffeesatz);
      @import url(https://fonts.googleapis.com/css?family=Droid+Serif:400,700,400italic);
      @import url(https://fonts.googleapis.com/css?family=Ubuntu+Mono:400,700,400italic);

      body { font-family: 'Droid Serif'; }
      h1, h2, h3 {
        font-family: 'Yanone Kaffeesatz';
        font-weight: normal;
      }
      .fade {color: #E0E0E0}
      .spanny { padding: 10px; color: white; background-color: #0b1c2e }
      .nopadding { padding: 0 }
      .libs { background-color: #202020}
      .l50 { float: left; width: 50%; }
      .r50 { float: right; width: 50%; }
      .crap pre { border-right: 5px solid #D81F2A; }
      .nice pre { border-right: 5px solid #69F0AE; }

      .corner {border: 5px solid #85C1E9; position: absolute; top: 0px; right: 0px; width: 50%; background-color: #F0F0F0}
      .corner pre {margin: 0; padding: 0}
      .corner.long {height: 300px;}

      .remark-code, .remark-inline-code { font-family: 'Ubuntu Mono'; }
      .invert { background-color: black; color: white; }
      .bad { background-color: #AA1914; color: white;}
      .oki { background-color: #3D9972; color: white;}
      .strike { text-decoration: line-through; }
      .lint { background-color: #f3f3f3; }
      .conversation h3 { margin: 17px; font-size: 28px; }
    </style>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.6.0/katex.min.css">
  </head>
  <body>
    <textarea id="source">

class: center, middle

# Effective Coding Principles and Patterns in Java 8, WTF part

---
can be prototype! and use power of setting state in constructor, avoid threadlocals.
instead of returning a set of validation errors, throw them!
calling commands from commands indicates a problem of reuse and are DANGEROUS. Change in UC1 can break UC2. Let them evolve independently!

---

```java
package infra.authentication;
class Anonym {
  private final Members members;
  Optional<Token> authenticationToken(String username, String password) {
    Optional<Member> member = members.byLoginAndPassword(username, password);
    return member.flatMap(() -> new JwtToken(username));
  }
}
```
--

```java
package app.membership;

class LogInCommandHandler implements CommandHandler<LogInCommand, LogInCommand.R> {
  @Autowired
  private final Anonym anonym;
  public R handle(LogInCommand $) {
    Token authToken = anonym
      .authenticationToken($.username(), $.password())
      .orElseThrow(() -> throw new InvalidCredentialsException($));

    return new R(authToken.text());
  }
}
```

--

```java
package app.membership;
interface Members {
  Member byLoginAndPassword(username, password);
}
```

--

.corner[
  ### - Bidi usage
  ### - Bidi dependency :(
  ### - Let's make Anonym reusable
]

---

```java
package infra.authentication;
class Anonym {
  private final Credentials credentials;
  Optional<Token> authenticationToken(String username, String password) {
    boolean validCredentials = credentials.areValid(username, password);
    return validCredentials ? Optional.of(new JwtToken(username)) : Optional.empty();
  }
}
```

```java
package infra.authentication;
interface Credentials {
  boolean areValid(String username, String password);
}
```

--

```java
package app.membership;
class MemberCredentials implements Credentials {
  private final Members members;
  @Override
  public boolean areValid(String username, String password) {
    members
      .byLoginAndPassword(username, password);
      .isPresent();
  }
}
```

--

.corner[
  ### - Bi-di usage
  ### - Uni-di dependency
  ### - Anonym is reusable now!
]

---
```java
javajitsu.infrastructure.sms
javajitsu.infrastructure.sms.twilio
javajitsu.application.notification
javajitsu.domain.notification
```

---
- We can add behaviour with decorators (open-closed)

---
# Working with legacy code
### Chia Pet Pattern
### Most development is about preserving behaviour
### Refactoring dilemma

---
Database is a detail. It's one of the way of representing your entity. Fine.

---
Bundle advanced functionality into separate objects. Functionality is hidden unless such objects are requested. (c) Scott Meyers
Instead of given all stuff, you have to ask for them.

---
Exhanging messages w/o calling each other. EvenBus!

---
“Behaviour-driven development is about
implementing an application by
describing it from the point of view of
its stakeholders” (c) Dan North


---
```
class Person {

    private final Age age;

    private final Sex sex;

    public Person(Age age, Sex sex) {
        this.age = age;
        this.sex = sex;
    }

    public Age age() {
        return age;
    }

    public Sex sex() {
        return sex;
    }
}

class Age {

    private final int age;

    public Age(int age) {
        this.age = age;
    }

    boolean isMajor() {
        return age > 18;
    }

    @Override
    public int compareTo(Age that) {
        // Guava in use!
        return Ints.compare(this.age, that.age);
    }

    @Override
    public int hashCode() {
        return Objects.hash(age);
    }

    @Override
    public boolean equals(@Nullable Object that) {
        if (that == null || getClass() != that.getClass()) {
            return false;
        }
        Age other = (Age) that;
        return Objects.equals(this.age, other.age);
    }
    guava-testlib

}

```
    Challenge: write equality w/o if conditions
    @Override
    public boolean equals(@Nullable Object that) {
        return new Equality<>(Age::age, Age::isMajor).equals(this, that);
    }

```
---
```
new EqualsTester()
    .addEqualityGroup("hello", "h" + "ello")
    .addEqualityGroup("world", "wor" + "ld")
    .addEqualityGroup(2, 1 + 1)
    .testEquals();
```
---

```
class Equality<T> {

    private final Collection<BiFunction<T, T, Boolean>> checks = new LinkedList<>();

    @SafeVarargs
    public Equality(Property<T, ?>... properties) {
        checks.add((me, you) -> you != null);
        checks.add((me, you) -> me.getClass() == you.getClass());
        checks.addAll(Arrays
                .stream(properties)
                .map(property -> (BiFunction<T, T, Boolean>) (T me, T you) -> Objects.equals(property.take(me), property.take(you)))
                .collect(Collectors.toList()));
    }


    boolean equals(Object me, @Nullable Object you) {
        return checks.stream().allMatch(fn -> fn.apply((T) me, (T) you));
    }
}
}
```


enum Sex {
    MALE, FEMALE
}
```
---
```
        Collection<Person> people = new ArrayList<>();
        List<Person> adultMales = people.stream().filter(new AdultMale()).collect(Collectors.toList());
```

---

---
```
interface Entity<T> {

    default boolean is(Predicate<T> predicate) {
        return predicate.test((T) this);
    }

}

class Person implements Entity<Person>
....

Age adultAge = new Age(18);
Person citizen = new Person(adultAge, Sex.MALE);
boolean adultMale = citizen.isSatisfiedBy(new IsAdultMale());
```
???
Entity is an interface! Wohoo!

---
SOLID (open/closed principle)
- Tempting to sublclass. We never subclass (almost.)
- DECORATORS! Hmm, also, with Decorators you can avoid making objects Configurable, A-ka SomeSettings.
The expression problem
The expression problem refers to the desire to implement an existing set of abstract methods for an existing concrete class without having to change the code that defines either. Object-oriented languages allow you to implement an existing abstract method in a concrete class you control (interface inheritance), but if the concrete class is outside your control, the options for making it implement new or existing abstract methods tend to be sparse. Many popular programming languages such as Ruby, Scala, C#, Groovy, and JavaScript provide partial solutions to this problem by allowing you to add methods to an existing concrete object, a feature sometimes known as monkey-patching, or interpose a different object between mismatched types via implicit conversion.


---
Encapsulated properties must not be used to change the behavior of an object.
for example - Password.



---
Rule of demeter / principle of least knowledge / don't talk to strangers / train wrecks

---
Jackson
- Jackson Guava (https://github.com/FasterXML/jackson-datatypes-collections) -> Multimap, Range, HashCode, InternetDomainName, HostAndPort, Optional
- Jackson JDK8 (https://github.com/FasterXML/jackson-datatype-jdk8) -> Optional
- Jackson JSR310 (https://github.com/FasterXML/jackson-datatype-jsr310) -> javax.date
- Jackson Parameter Names module (https://github.com/FasterXML/jackson-module-parameter-names) ->

---
```
class Person {     // mandatory fields     private final String name;     private final String surname;     // optional fields     private String nickname;     // no annotations are required if preconditions are met (details below)     public Person(String name, String surname) {
```

---
Afterburner
```
<dependency>
  <groupId>com.fasterxml.jackson.module</groupId>
  <artifactId>jackson-module-afterburner</artifactId>
  <version>2.7.1</version>
</dependency>
```

```
ObjectMapper mapper = new ObjectMapper()
mapper.registerModule(new AfterburnerModule());
```

---
# Frameworks
- awaitility
- hicariCP -  the fastest connection pool in Java land
- caffeine - the fastes near-cache in Java land. Can be used as Spring Cache in Spring 4.3

---
LoadingCache<String, Book> booksByTitle = Caffeine.newBuilder()
    .maximumSize(10_000)
    .expireAfterAccess(5, TimeUnit.MINUTES)
    .refreshAfterWrite(1, TimeUnit.MINUTES)
    .build(title -> { // Using a jOOQ repository
      return database.selectFrom(BOOK)
          .where(BOOK.TITLE.eq(title))
          .fetchOneInto(Book.class);
    });

// A classic about a prison revolt (TANSTAAFL!)
Book favorite = booksByTitle.get(“The Moon Is a Harsh Mistress”);

// A good way to spend a long, rainy weekend
Map<String, Book> series = booksByTitle.getAll(Arrays.asList(
  “A Game of Thrones”, “A Clash of Kings”, ...));

---
Stability Patterns
- Retries

---
I like comments! What I like of comments is deleting them
- make implicit explicit
- method names instead of comments
- comments explain each code block :( methods!
- exceptions - performance implications, regexes.
- todo: use paper.
- QCs :-) version control is for that.
- kill commented out code. That's what VC is for.
- javadocs

---
Exception handling
throw new Exception("o_O")
Validation may be a differnet kind of exception.

---
Identify and stop the process that's listening on port 8080 or configure this application to listen on another port.

---
background-image:url(prodex.jpg)

---
- JSR validation is not designed for domain validation / business rules. Only input.
- Business stuff depends on INPUT being correct, not NULLS etc. So it comes first.
- Input validation is (normally) connected to a FIELD. Business - not composition of stuff.

---
class: center, middle, invert
# Logging

---
# Slf4j please.
### - Bridges for all common logging frameworks
### - Single dependency on `slf4-api`

---
# Logback please.
### - Native, zero-overhead implementation of Slf4j
### - Supports configuration via flexible Groovy DSL
### - Supports asynchonous logging via AsyncAppender
### - Supports {} to variables to avoid concatenation
### - log.isDebugEnabled() check is [almost] obsolete.
???
- Groovy can access your classpath. So you can do type-safe stuff.
- Consider log4j 2 - faster async via disruptor, custom log levels, custom formatters, lazy args.
- Lambda support in Slf4j is planned in the next release - 1.8.

---
# MDC (Mapped Diagnostic Context)
```java
MDC.put("userId", new LoggedUserId(user));
// userId is available to logger
MDC.remove("userId");
```
```java
MDC.MDCCloseable handle = MDC.putCloseable("userId", new LoggedUserId(user));
// userId is available to logger
handle.close();
```

```groovy
import ch.qos.logback.classic.encoder.PatternLayoutEncoder
import ch.qos.logback.core.ConsoleAppender
appender("STDOUT", ConsoleAppender) {
    encoder(PatternLayoutEncoder) {
      pattern = "[%thread] %mdc{userId:-UNKNOWN} - %msg%n"
    }
}
root DEBUG, ["STDOUT"]
```
???
- so you don't have to pass userId every time you log the message.
- every log message will contain a userId information.
- *putCloseable** is awkward. MDCItem.remove();

---
# Markers
```java
class Tx {

  static Marker CHATOPS = MarkerManager.getMarker("CHATOPS");

  void execute() {
    log.error(CHATOPS, "Oh sh%t, transaction failed", new Tx.Failed(cause));
  }
}
```
```groovy
appender("DEFAULT", ConsoleAppender) {
    encoder(PatternLayoutEncoder) {
        pattern = "%m%n"
    }
}
appender("CHATOPS", SlackAppender) {
    channel = "chatops"
    filter(EvaluatorFilter) {
        evaluator(OnMarkerEvaluator) { marker = "CHATOPS" }
        onMatch = "ACCEPT"
    }
}

root DEBUG, ["DEFAULT", "CHATOPS"]
```
???
- you also filter-out messages for a given marker (e.g. commands that do not need to be logged)

---
background-image:url(12factor.jpg)
???
- Software must write to sysout
- Fluentd

---
# Make implicit explicit
```java
class Command {

    String firstName;
    String lastName;

    @Override
    public String toString() {
        return MoreObjects.toStringHelper(this)
                .add("firstName", firstName)
                .add("lastName", lastName)
                .toString();
    }
}

log.info("Command received", new Command("Chuck", "Norris"));
```

---
# Make implicit explicit
```java
class Command implements Loggable {

    String firstName;
    String lastName;

    @Override
    public String toString() {
        return MoreObjects.toStringHelper(this)
                .add("firstName", firstName)
                .add("lastName", lastName)
                .toString();
    }

    @Override
    public String toLogString() {
      return Joiner.on(' ').join(firstName, lastName);
    }
}

log.info("Command received", new Command("Chuck", "Norris").toLogString());
```

---
# Log or rethrow. Never do both.
```java
  class Mailgun {
      void send(Email email) {
        try {
            // try to send email...
        } catch(IOException e) {
*           log.error("Mailgun is unavailable", e);
            throw new MailgunUnavailable("Mailgun is unavailable", e);
        }
      }
  }

  class SubscriptionReminder {
      Mailgun mailgun;
      void remind() {
          Email email = new Email(...);
          try {
            mailgun.send(email);
          } catch (MailgunUnavailable e) {
            log(e);
            reschedule();
          }
      }
  }
```
???
- MESS in log files. Same shit many times.
- VERY common and hard to make right.
- preserve exception cause hierarchy.

---
# Log or rethrow. Never do both.
```java
  class Mailgun {
      void send(Email email) {
        try {
            // try to send email...
        } catch(IOException e) {
            throw new MailgunUnavailable("Mailgun is unavailable", e);
        }
      }
  }

  class SubscriptionReminder {
      Mailgun mailgun;
      void remind() {
          Email email = new Email(...);
          try {
            mailgun.send(email);
          } catch (MailgunUnavailable e) {
            log(e);
            reschedule();
          }
      }
  }
```
???
- Hei, fucking handle me, calle!
- This why the idea of CHECKED exception is not THAT bad :-)
- log(e) and reschedule() level of abstraction!!!

---
# Use color-coding and indentation
```groovy
pattern = "%highlight(%-6(%level)) | %+20(%logger{20}) | %thread | %cyan(%mdc{tx}) | %m%n"
```
![](color-code.png)

---
```java
class Vault {

    private final Logger log;
    private final String accessToken;

    public Vault(String accessToken) {
        this(accessToken, LoggerFactory.getLogger(Vault.class));
    }

    @VisibleForTesting
    Vault(String accessToken, Logger log) {
        this.accessToken = accessToken;
        this.log = log;
    }

}

class VaultSpec {

    Logger logger = Mock(Logger.class);
    Vault vault = new Vault("someToken", logger);

    void doesSomeBlackMagic() {
        // ...
    }

}
```

---
```java
 @Rule
 public LogbackVerifier logbackVerifier = new LogbackVerifier();

    private MyTestedService service = new MyTestedService();

    @Test
    public void verifyGoodScenario() throws Exception {
        logbackVerifier.expectMessage(Level.INFO, "it worked");
    }
```

---
```java
public class LogbackVerifier implements TestRule {

    private Logger rootLogger = (Logger) LoggerFactory.getLogger(Logger.ROOT_LOGGER_NAME);
    private Appender<ILoggingEvent> appender = ... // your Appender impl.

    @Override
    public Statement apply(final Statement base, Description description) {
        return new Statement() {
            @Override
            public void evaluate() throws Throwable {
                before();
                try {
                    base.evaluate();
                    verify();
                } finally {
                    after();
                }
            }
        };
    }

    private void before() {
        rootLogger.addAppender(appender);
    }

    private void after() {
        rootLogger.detachAppender(appender);
    }

    private void verify() { ... }

    public void expectMessage(Level level, String message) { ... }

}
```

---
### Case against Spring Data
### Case against JPA
### Go Hibernate or JDBC (or some better wrapper, like [Fluent JDBC](http://jdbc.jcabi.com/), [JDBI](http://www.jdbi.org/), [JdbcTemplate](https://docs.spring.io/spring/docs/2.0.x/javadoc-api/org/springframework/jdbc/core/JdbcTemplate.html))

```
jDBI provides a convenience interface for SQL operations in Java. **It is not intended as an abstraction layer, but rather a library** which makes the common things easy and the hard things possible, to paraphrase Larry Wall.
```

### no save();
### Redis no save() with IMMEDIATE changes, so RedisQuestionCount implements QuestionCount


---
background-image:url(javaslang.png)

---
```java
Arrays.asList(2, 3, 1)
  .stream()
  .sorted()
  .collect(Collectors.toList());
```

--

```java
List.of(2, 3, 1).sort();
```

--
```java
Try.of(() -> bunchOfWork()).getOrElse(other);
```

--
```java
String s = Match(i).of(
    Case(is(1), "one"),
    Case(is(2), "two"),
    Case($(), "?")
);
```

--
### Be careful, doesn't seem the right place for circuit breaking!
http://www.javaslang.io/javaslang-circuitbreaker/0.5.0/

---
### More
- [curated list of great IT videos](https://github.com/latcraft/what2watch)
- [my goodreads](https://goodreads.com/eduardsi)

---
DevTernity

----

    </textarea>
    <script src="https://gnab.github.io/remark/downloads/remark-latest.min.js"></script>
    <script>
      var slideshow = remark.create({
        highlightLines: true,
        slideNumberFormat: function (current, total) { return "" }
      });
    </script>

  </body>
</html>
